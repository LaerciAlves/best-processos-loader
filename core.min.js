// ======================================
// üßæ LOG GLOBAL (ETAPA 21) ‚Äî buffer + DEV-only output
// ======================================
window.__CAF_PRELOGS = window.__CAF_PRELOGS || [];

function LOG(...args) {
  try {
    const C = window.CAF;

    // s√≥ imprime se DEV estiver ativo
    if (C && C.logs && C.logs.enabled === true) {
      console.log("%c[CAF-AUTO]", "color:#00bcd4;font-weight:bold;", ...args);
      return;
    }

    // sen√£o, guarda no buffer (para flush quando DEV ligar)
    window.__CAF_PRELOGS.push(args);
  } catch (e) {}
}

//(function () {
//  "use strict";
// alert("üî• SCRIPT CAF CARREGADO");   // üëà ADICIONE ESTA LINHA AQUI

(function iniciarCAFCore() {
  function bootCAF() {
    // ======================================
    // üîß NAMESPACE GLOBAL DO PROJETO
    // ======================================

    window.CAF = window.CAF || {};

    CAF.storage = {};
    CAF.logs = {};
    CAF.engine = {};
    CAF.ui = {};
    CAF.planilha = {};
    CAF.security = {};

    // ======================================
    // üîê ACCESS GATE ‚Äî usu√°rio do site + whitelist + master bypass
    // ======================================
    CAF.security = CAF.security || {};

    CAF.security._LIC_CACHE_KEY = "CAF_LIC_CACHE_V1";
    CAF.security._LIC_TTL_MS = 5 * 60 * 1000; // 5 minutos

    CAF.security._msg = function (title, detail) {
      try {
        alert(`${title}\n\n${detail || ""}`.trim());
      } catch (e) {}
    };

    CAF.security.ensureAccess = async function () {
      try {
        // ‚úÖ MASTER: libera tudo
        if (
          CAF.dev &&
          typeof CAF.dev.isAuthorized === "function" &&
          CAF.dev.isAuthorized()
        ) {
          return { ok: true, mode: "master" };
        }

        // ‚úÖ Usu√°rio real do site
        const userRaw =
          CAF.auth && typeof CAF.auth.getLoggedUser === "function"
            ? CAF.auth.getLoggedUser()
            : null;

        const user = String(userRaw || "")
          .replace(/\s+/g, " ")
          .trim();

        // ‚ùå Se n√£o identificar usu√°rio: bloqueia tudo (exceto master)
        if (!user) {
          return { ok: false, reason: "NO_USER" };
        }

        const userKey = user.toLowerCase();

        // ‚úÖ Cache para n√£o chamar o Worker a cada clique
        const now = Date.now();
        const cache = CAF.storage.get(CAF.security._LIC_CACHE_KEY, null);

        if (
          cache &&
          cache.user === userKey &&
          typeof cache.ts === "number" &&
          now - cache.ts < CAF.security._LIC_TTL_MS
        ) {
          return cache.allowed
            ? { ok: true, mode: "user", user }
            : { ok: false, reason: "NOT_ALLOWED", user };
        }

        // ‚úÖ Valida na whitelist do Worker
        const res = await CAF.api.request({
          action: "license_check",
          user: userKey,
        });

        const allowed = !!(res && res.ok && res.allowed === true);

        CAF.storage.set(CAF.security._LIC_CACHE_KEY, {
          ts: now,
          user: userKey,
          allowed,
        });

        return allowed
          ? { ok: true, mode: "user", user }
          : { ok: false, reason: "NOT_ALLOWED", user };
      } catch (e) {
        return { ok: false, reason: "ERROR", detail: String(e?.message || e) };
      }
    };

    CAF.security.guard = async function (featureName) {
      const r = await CAF.security.ensureAccess();

      if (r.ok) return true;

      if (r.reason === "NO_USER") {
        CAF.security._msg(
          "‚õî Bloqueado",
          "Usu√°rio n√£o identificado no site.\n\nFa√ßa login no sistema (onde aparece 'Usu√°rio: ...') ou use o MASTER (DEV) para liberar.",
        );
        return false;
      }

      if (r.reason === "NOT_ALLOWED") {
        CAF.security._msg(
          "‚õî Bloqueado",
          `Usu√°rio "${r.user}" n√£o est√° autorizado (whitelist).\n\nSe precisar, libere no Worker (allowedUsers).`,
        );
        return false;
      }

      CAF.security._msg(
        "‚õî Bloqueado",
        `Falha na valida√ß√£o de acesso.\n${r.detail || ""}`,
      );
      return false;
    };

    // ======================================
    // üîí UI LOCK ‚Äî trava/destrava bot√µes de verdade (overlay + disable)
    // ======================================
    CAF.ui = CAF.ui || {};
    CAF.ui._lock = { locked: false, reason: "" };

    CAF.ui.setLocked = function (locked, reason) {
      CAF.ui._lock.locked = !!locked;
      CAF.ui._lock.reason = String(reason || "");

      // Painel j√° existe no seu c√≥digo como "panel"
      const panelEl = panel || document.querySelector("#caf-panel");

      // S√≥ trava bot√µes do CAF (rightBox)
      const scope = rightBox || panelEl || document.body;
      const buttons = scope.querySelectorAll("button");

      buttons.forEach((b) => {
        // trava tudo do rightBox (s√≥ seus bot√µes)
        b.disabled = !!locked;
        b.style.opacity = locked ? "0.55" : "1";
        b.style.cursor = locked ? "not-allowed" : "pointer";
      });

      if (!panelEl) return;

      // overlay
      let ov = panelEl.querySelector("#cafLockOverlay");
      if (!ov) {
        ov = document.createElement("div");
        ov.id = "cafLockOverlay";
        ov.style.cssText = `
      position:absolute; inset:0;
      display:none;
      align-items:center; justify-content:center;
      padding:10px;
      background:rgba(15,23,42,.35);
      backdrop-filter: blur(2px);
      z-index:999999;
    `;
        const cs = getComputedStyle(panelEl);
        if (cs.position === "static") panelEl.style.position = "relative";
        panelEl.appendChild(ov);
      }

      if (locked) {
        ov.style.display = "flex";
        ov.innerHTML = `
      <div style="
        background:#0f172a;color:#fff;
        border:1px solid rgba(255,255,255,.15);
        border-radius:10px;
        padding:10px 12px;
        max-width:420px;
        box-shadow:0 10px 24px rgba(0,0,0,.25);
        font-family:Arial,sans-serif;
        font-size:12px;
        line-height:1.35;
      ">
        <div style="font-weight:700;font-size:13px;margin-bottom:6px;">üîí Acesso bloqueado</div>
        <div style="opacity:.92;white-space:pre-line;">${CAF.ui._lock.reason || "Usu√°rio n√£o autorizado."}</div>
        <div style="margin-top:8px;opacity:.8;font-size:11px;">
          Para liberar: acesse com usu√°rio autorizado ou use o MASTER (Shift, Shift, D).
        </div>
      </div>
    `;
      } else {
        ov.style.display = "none";
      }
    };

    // ======================================
    // üíæ STORAGE WRAPPER (ETAPA 2)
    // ======================================

    CAF.storage.get = function (key, def = null) {
      try {
        const v = sessionStorage.getItem(key);
        return v ? JSON.parse(v) : def;
      } catch (e) {
        if (CAF.logs && CAF.logs.enabled)
          console.warn("CAF.storage.get erro", key, e);
        return def;
      }
    };

    CAF.storage.set = function (key, value) {
      try {
        sessionStorage.setItem(key, JSON.stringify(value));
      } catch (e) {
        if (CAF.logs && CAF.logs.enabled)
          console.warn("CAF.storage.set erro", key, e);
      }
    };

    CAF.storage.remove = function (key) {
      try {
        sessionStorage.removeItem(key);
      } catch (e) {
        if (CAF.logs && CAF.logs.enabled)
          console.warn("CAF.storage.remove erro", key, e);
      }
    };

    // ======================================
    // üßæ CAF ENCERRADAS (LOCALSTORAGE) ‚Äî ETAPA 11
    // ======================================

    const CAF_CLOSED_KEY = "CAF_CLOSED_V1";

    CAF.storage.getClosedMap = function () {
      try {
        return JSON.parse(localStorage.getItem(CAF_CLOSED_KEY) || "{}") || {};
      } catch (e) {
        return {};
      }
    };

    CAF.storage.saveClosedMap = function (map) {
      try {
        localStorage.setItem(CAF_CLOSED_KEY, JSON.stringify(map || {}));
      } catch (e) {}
    };

    // registra encerramento de uma CAF (idempotente)
    CAF.storage.markClosed = function (caf, meta) {
      try {
        const m = CAF.storage.getClosedMap();
        const key = String(caf || "").trim();
        if (!key) return false;

        if (!m[key]) {
          m[key] = meta || {};
          CAF.storage.saveClosedMap(m);
        }
        return true;
      } catch (e) {
        return false;
      }
    };

    // ======================================
    // üîê DEV AUTH FLAG (ETAPA 19.D) ‚Äî com persist√™ncia por ABA (sessionStorage)
    // ======================================
    CAF.dev = CAF.dev || {};
    CAF.dev.auth = CAF.dev.auth || { allowed: false };

    const DEV_FLAG_KEY = "CAF_DEV_ALLOWED"; // s√≥ flag, N√ÉO guarda senha

    // restaura autoriza√ß√£o DEV ao recarregar (na mesma aba)
    try {
      if (sessionStorage.getItem(DEV_FLAG_KEY) === "1") {
        CAF.dev.auth.allowed = true;
      }
    } catch (e) {}

    CAF.dev.setAuthorized = function (v) {
      try {
        CAF.dev.auth.allowed = v === true;

        // persiste por ABA (some ao fechar a aba)
        try {
          if (CAF.dev.auth.allowed) sessionStorage.setItem(DEV_FLAG_KEY, "1");
          else sessionStorage.removeItem(DEV_FLAG_KEY);
        } catch (e) {}

        return CAF.dev.auth.allowed;
      } catch (e) {
        return false;
      }
    };

    CAF.dev.isAuthorized = function () {
      try {
        return CAF.dev.auth.allowed === true;
      } catch (e) {
        return false;
      }
    };

    // ======================================
    // üìã LOGGER PROFISSIONAL (ETAPA 3)
    // ======================================

    CAF.logs.buffer = [];

    CAF.logs.debug = function (...args) {
      try {
        LOG(...args);
      } catch (e) {}
    };

    CAF.logs.step = function (obj) {
      try {
        CAF.logs.buffer.push(obj);
      } catch (e) {
        console.warn("CAF.logs.step erro", e);
      }
    };

    CAF.logs.clear = function () {
      CAF.logs.buffer = [];
    };

    // ======================================
    // üß™ CONTROLE GLOBAL DE LOG (ETAPA 4)
    // ======================================

    // üîê padr√£o: logs DESLIGADOS para usu√°rios
    CAF.logs.enabled = false;

    CAF.logs.enable = function () {
      // ‚úÖ ETAPA 19.D ‚Äî bloqueia enable manual sem autoriza√ß√£o
      if (!(CAF.dev && CAF.dev.isAuthorized && CAF.dev.isAuthorized())) {
        return false;
      }

      // evita reimprimir/rodar tudo de novo
      if (CAF.logs.enabled === true) return true;

      CAF.logs.enabled = true;

      console.warn("üß™ CAF DEV MODE ATIVADO");

      // ‚úÖ ETAPA 21 ‚Äî flush logs que ocorreram antes do DEV
      try {
        const pre = window.__CAF_PRELOGS || [];
        if (pre.length) {
          for (const a of pre) {
            console.log(
              "%c[CAF-AUTO]",
              "color:#00bcd4;font-weight:bold;",
              ...args,
            );
          }
          pre.length = 0;
        }
      } catch (e) {}

      CAF.logs.ensureDevDownloadButton();

      return true;
    };

    CAF.logs.disable = function () {
      CAF.logs.enabled = false;

      console.warn("üîí CAF DEV MODE DESATIVADO");

      return true; // üî• agora retorna status
    };

    // ======================================
    // üîÅ AUTO-RESTORE DEV LOG (ETAPA 21)
    // roda uma vez ao carregar, n√£o entra em loop
    // ======================================
    try {
      if (CAF.dev && CAF.dev.isAuthorized && CAF.dev.isAuthorized()) {
        // chama enable uma √∫nica vez
        CAF.logs.enable();
      }
    } catch (e) {}

    // ======================================
    // üïµÔ∏è DEV PROMPT (ETAPA 19.A) ‚Äî trigger oculto + modal
    // ======================================

    CAF.dev = CAF.dev || {};

    CAF.dev.STATE = {
      open: false,
      lastShiftTs: 0,
      armed: false,
    };

    CAF.dev.hotkey = {
      // Shift, Shift, D (dentro da janela)
      windowMs: 900,
      finalKey: "d",
    };

    CAF.dev.ensureStyles = function () {
      try {
        if (document.getElementById("cafDevPromptStyle")) return;

        const st = document.createElement("style");
        st.id = "cafDevPromptStyle";
        st.textContent = `
      #cafDevPromptOverlay{
  position: fixed;
  inset: 0;
  z-index: 999999;
  background: rgba(0,0,0,.35);
  display: none;
  align-items: center;
  justify-content: center;
  padding: 10px;              /* ‚úÖ nunca encosta na borda */
  box-sizing: border-box;
}

#cafDevPromptOverlay, #cafDevPromptOverlay *{
  box-sizing: border-box;     /* ‚úÖ evita ‚Äúestourar‚Äù por padding/borda */
}

#cafDevPromptCard{
  width: clamp(340px, 92vw, 460px);  /* ‚úÖ maior, mas nunca passa do viewport */
  background: #0b1220;
  color: #fff;
  border: 1px solid rgba(255,255,255,.12);
  border-radius: 12px;
  box-shadow: 0 12px 28px rgba(0,0,0,.35);
  padding: 12px;
  font-family: Arial, sans-serif;
}

#cafDevPromptCard h4{
  margin: 0 0 8px 0;
  font-size: 14px;
  font-weight: 700;
}

.cafDevRow{ margin-top: 8px; }

.cafDevRow label{
  display:block;
  font-size: 11px;
  opacity: .85;
  margin-bottom: 4px;
}

/* ‚úÖ input mais ‚Äúcurto‚Äù (altura/padding menor), mas sempre cabe */
.cafDevRow input{
  width: 100%;
  max-width: 100%;
  padding: 6px 10px;          /* ‚úÖ reduz ‚Äúcomprimento visual‚Äù */
  height: 32px;               /* ‚úÖ input mais baixo */
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,.16);
  background: rgba(255,255,255,.06);
  color: #fff;
  outline: none;
  font-size: 12px;
}

#cafDevPromptHint{
  margin-top: 8px;
  font-size: 11px;
  opacity: .8;
}

.cafDevActions{
  display:flex;
  gap: 8px;
  justify-content: flex-end;
  margin-top: 10px;
  flex-wrap: wrap;            /* ‚úÖ se ficar apertado, quebra linha sem estourar */
}

.cafDevBtn{
  padding: 7px 10px;
  height: 32px;               /* ‚úÖ combina com input */
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,.16);
  background: rgba(255,255,255,.08);
  color:#fff;
  cursor:pointer;
  font-size: 12px;
}

.cafDevBtnPrimary{
  background: #2563eb;
  border-color: rgba(255,255,255,.08);
}
    `;
        document.head.appendChild(st);
      } catch (e) {}
    };

    CAF.dev.ensureUI = function () {
      try {
        if (document.getElementById("cafDevPromptOverlay")) return;

        CAF.dev.ensureStyles();

        const overlay = document.createElement("div");
        overlay.id = "cafDevPromptOverlay";

        const card = document.createElement("div");
        card.id = "cafDevPromptCard";

        card.innerHTML = `
      <h4>Modo DEV (restrito)</h4>

      <div class="cafDevRow">
        <label>Usu√°rio</label>
        <input id="cafDevUser" type="text" autocomplete="off" spellcheck="false" />
      </div>

      <div class="cafDevRow">
        <label>Senha</label>
        <input id="cafDevPass" type="password" autocomplete="off" spellcheck="false" />
      </div>

      <div id="cafDevPromptHint">‚ö†Ô∏è Credenciais n√£o s√£o armazenadas.</div>

      <div class="cafDevActions">
        <button class="cafDevBtn" id="cafDevCancel" type="button">Cancelar</button>
        <button class="cafDevBtn cafDevBtnPrimary" id="cafDevOk" type="button">Validar</button>
      </div>
    `;

        overlay.appendChild(card);
        document.body.appendChild(overlay);

        // fecha clicando fora
        overlay.addEventListener("click", (ev) => {
          if (ev.target === overlay) CAF.dev.close();
        });

        // bot√µes
        document
          .getElementById("cafDevCancel")
          .addEventListener("click", () => CAF.dev.close());
        document
          .getElementById("cafDevOk")
          .addEventListener("click", () => CAF.dev.submit());

        // Enter = Validar
        ["cafDevUser", "cafDevPass"].forEach((id) => {
          const el = document.getElementById(id);
          if (!el) return;
          el.addEventListener("keydown", (ev) => {
            if (ev.key === "Enter") {
              ev.preventDefault();
              CAF.dev.submit();
            }
          });
        });

        // ESC fecha
        document.addEventListener(
          "keydown",
          (ev) => {
            if (!CAF.dev.STATE.open) return;
            if (ev.key === "Escape") CAF.dev.close();
          },
          true,
        );
      } catch (e) {}
    };

    CAF.dev.open = function () {
      try {
        CAF.dev.ensureUI();
        const o = document.getElementById("cafDevPromptOverlay");
        if (!o) return false;

        o.style.display = "flex";
        CAF.dev.STATE.open = true;

        // limpa campos (n√£o guarda)
        const u = document.getElementById("cafDevUser");
        const p = document.getElementById("cafDevPass");
        if (u) u.value = "";
        if (p) p.value = "";

        setTimeout(() => {
          try {
            u && u.focus();
          } catch (e) {}
        }, 50);

        return true;
      } catch (e) {
        return false;
      }
    };

    CAF.dev.close = function () {
      try {
        const o = document.getElementById("cafDevPromptOverlay");
        if (o) o.style.display = "none";
        CAF.dev.STATE.open = false;

        // zera campos
        const u = document.getElementById("cafDevUser");
        const p = document.getElementById("cafDevPass");
        if (u) u.value = "";
        if (p) p.value = "";

        return true;
      } catch (e) {
        return false;
      }
    };

    CAF.dev.submit = async function () {
      try {
        const user = (
          document.getElementById("cafDevUser")?.value || ""
        ).trim();
        const pass = document.getElementById("cafDevPass")?.value || "";

        // n√£o persiste credencial em lugar nenhum
        if (!user || !pass) {
          if (CAF.logs && CAF.logs.enabled) {
            console.warn("DEV prompt: preencha usu√°rio e senha.");
          }
          return false;
        }

        // Placeholder: Parte B vai trocar isso por chamada na API
        if (typeof CAF.dev.onSubmit === "function") {
          await CAF.dev.onSubmit(user, pass);
        } else {
          // por enquanto s√≥ fecha
          if (CAF.logs && CAF.logs.enabled) {
            console.warn(
              "DEV prompt: handler CAF.dev.onSubmit ainda n√£o configurado (Parte B).",
            );
          }
        }

        // sempre limpa e fecha
        CAF.dev.close();
        return true;
      } catch (e) {
        try {
          CAF.dev.close();
        } catch (_e) {}
        return false;
      }
    };

    // listener hotkey (Shift + Shift + D)
    CAF.dev.installHotkey = function () {
      try {
        if (CAF.dev.STATE.armed) return;
        CAF.dev.STATE.armed = true;

        document.addEventListener(
          "keydown",
          (ev) => {
            try {
              // n√£o disparar dentro de input/textarea
              const tag =
                ev.target && ev.target.tagName
                  ? ev.target.tagName.toLowerCase()
                  : "";
              if (tag === "input" || tag === "textarea") return;

              const now = Date.now();

              if (ev.key === "Shift") {
                CAF.dev.STATE.lastShiftTs = now;
                return;
              }

              // janela v√°lida?
              const delta = now - (CAF.dev.STATE.lastShiftTs || 0);
              if (delta > 0 && delta <= CAF.dev.hotkey.windowMs) {
                if (
                  String(ev.key || "").toLowerCase() === CAF.dev.hotkey.finalKey
                ) {
                  CAF.dev.open();
                }
              }
            } catch (e) {}
          },
          true,
        );
      } catch (e) {}
    };

    // instala quando o body existir
    (function initDevPrompt() {
      try {
        const kick = () => {
          if (!document.body) {
            requestAnimationFrame(kick);
            return;
          }
          CAF.dev.installHotkey();
        };
        kick();
      } catch (e) {}
    })();

    // ======================================
    // ‚úÖ DEV LOGIN HANDLER (ETAPA 19.B)
    // ======================================

    CAF.dev.onSubmit = async function (user, pass) {
      try {
        const res = await CAF.api.request({
          action: "dev_login",
          user,
          pass,
        });

        if (res && res.ok && res.devAllowed === true) {
          // ‚úÖ ETAPA 19.D ‚Äî libera enable apenas ap√≥s valida√ß√£o API
          CAF.dev.setAuthorized(true);

          CAF.logs.enable(); // agora passa pelo gate
          if (CAF.logs && CAF.logs.enabled) {
            console.warn("üß™ DEV liberado via API (master).");
          }
          try {
            CAF.ui.setLocked(false, "");
          } catch (e) {}
          return true;
        }

        // resposta neutra (sem dar dica)
        if (CAF.logs && CAF.logs.enabled) {
          console.warn("DEV negado.");
        } else {
          // se DEV ainda n√£o est√° ligado, s√≥ um alert discreto
          alert("DEV negado.");
        }

        return false;
      } catch (e) {
        alert("Falha ao validar DEV.");
        return false;
      }
    };

    // ======================================
    // üîå CAF API CLIENT (ETAPA 19.B)
    // core -> content.js via postMessage
    // ======================================

    CAF.api = CAF.api || {};

    CAF.api.request = function (payload, timeoutMs = 12000) {
      return new Promise((resolve) => {
        const requestId = `req_${Date.now()}_${Math.random().toString(16).slice(2)}`;
        let done = false;

        const timer = setTimeout(() => {
          if (done) return;
          done = true;
          window.removeEventListener("message", onMsg, true);
          resolve({ ok: false, erro: "timeout" });
        }, timeoutMs);

        function onMsg(ev) {
          try {
            const msg = ev.data || {};
            if (msg.type !== "CAF_API_RES") return;
            if (msg.requestId !== requestId) return;

            if (done) return;
            done = true;

            clearTimeout(timer);
            window.removeEventListener("message", onMsg, true);

            resolve(msg.data || { ok: false });
          } catch (e) {
            // ignore
          }
        }

        window.addEventListener("message", onMsg, true);
        window.postMessage({ type: "CAF_API_REQ", requestId, payload }, "*");
      });
    };

    // ======================================
    // üîê AUTH (ETAPA 20.1) ‚Äî usu√°rio logado + mock DEV
    // ======================================

    CAF.auth = CAF.auth || {};

    // chave s√≥ para DEV (n√£o usar em produ√ß√£o)
    CAF.auth.MOCK_KEY = "CAF_DEV_MOCK_USER";

    CAF.auth.setMockUser = function (user) {
      try {
        if (!(CAF.logs && CAF.logs.enabled)) return false; // ‚úÖ s√≥ DEV
        const u = String(user || "").trim();
        if (!u) return false;
        localStorage.setItem(CAF.auth.MOCK_KEY, u);
        return true;
      } catch (e) {
        return false;
      }
    };

    CAF.auth.clearMockUser = function () {
      try {
        if (!(CAF.logs && CAF.logs.enabled)) return false; // ‚úÖ s√≥ DEV
        localStorage.removeItem(CAF.auth.MOCK_KEY);
        return true;
      } catch (e) {
        return false;
      }
    };

    CAF.auth.getMockUser = function () {
      try {
        const u = String(localStorage.getItem(CAF.auth.MOCK_KEY) || "").trim();
        return u || null;
      } catch (e) {
        return null;
      }
    };

    // tenta capturar o usu√°rio logado via DOM (placeholder robusto)
    // depois, quando voc√™ estiver no site, ajustamos os seletores reais
    CAF.auth.getLoggedUser = function () {
      try {
        // 1) DEV mock (se existir)
        const mock = CAF.auth.getMockUser();
        if (mock) return mock;

        // 2) ‚úÖ ICS (fonte oficial do usu√°rio)
        // <div id="header_dados"> ... <a href=".../agentes/trocar_senha.php?...">Denize</a>
        const icsEl = document.querySelector(
          '#header_dados a[href*="trocar_senha.php"]',
        );
        if (icsEl) {
          const nome = String(icsEl.textContent || "")
            .replace(/\s+/g, " ")
            .trim();
          if (nome) return nome;
        }

        // 3) Fallback gen√©rico (outros sites / layouts)
        const candidates = [];

        const sel = [
          "[data-user]",
          "[data-username]",
          ".user-name",
          ".username",
          ".logged-user",
          "#user",
          "#username",
          ".navbar .user",
          ".topbar .user",
        ];

        for (const s of sel) {
          const el = document.querySelector(s);
          if (el) {
            const v1 = (el.getAttribute("data-user") || "").trim();
            const v2 = (el.getAttribute("data-username") || "").trim();
            const v3 = (el.innerText || "").trim();
            if (v1) candidates.push(v1);
            if (v2) candidates.push(v2);
            if (v3) candidates.push(v3);
          }
        }

        const clean = candidates
          .map((x) =>
            String(x || "")
              .replace(/\s+/g, " ")
              .trim(),
          )
          .filter((x) => x && x.length >= 3 && x.length <= 60);

        return clean.length ? clean[0] : null;
      } catch (e) {
        return null;
      }
    };

    // ======================================
    // üß™ DEV LOG EXPORT + SNAPSHOT (DEV ONLY)
    // ======================================

    const CAF_DEBUG_SNAPSHOT_KEY = "CAF_DEBUG_SNAPSHOT_V1";

    CAF.logs.buildDebugPayload = function () {
      let logs = [];

      // 1) tenta pegar da vari√°vel em mem√≥ria (mais fiel)
      try {
        if (Array.isArray(logsProcessamento) && logsProcessamento.length) {
          logs = logsProcessamento;
        }
      } catch (e) {}

      // 2) fallback: sessionStorage (entre p√°ginas)
      if (!logs || !logs.length) {
        try {
          logs =
            JSON.parse(sessionStorage.getItem(AUTO_LOGS_KEY) || "[]") || [];
        } catch (e) {
          logs = [];
        }
      }

      // 3) fallback final: snapshot salvo em localStorage
      if (!logs || !logs.length) {
        try {
          const snap = JSON.parse(
            localStorage.getItem(CAF_DEBUG_SNAPSHOT_KEY) || "null",
          );
          if (snap && Array.isArray(snap.logs) && snap.logs.length) {
            logs = snap.logs;
          }
        } catch (e) {}
      }

      const payload = {
        createdAtLocal: new Date().toLocaleString("pt-BR"),
        createdAtISO: new Date().toISOString(),
        host: location.host,
        url: location.href,
        scriptHash: window.__CAF_SCRIPT_HASH || "N/A",
        runId: (CAF.engine.getRunId && CAF.engine.getRunId()) || "",
        attempt: (CAF.engine.getAttempt && CAF.engine.getAttempt()) || 1,
        eventSeq: (function () {
          try {
            return Number(sessionStorage.getItem(CAF_EVENT_SEQ_KEY) || "0");
          } catch (e) {
            return 0;
          }
        })(),
        pendentesSalvas:
          (CAF.engine.getPendentesSalvas && CAF.engine.getPendentesSalvas()) ||
          [],
        finalReport:
          (CAF.engine.getRelatorioFinal && CAF.engine.getRelatorioFinal()) ||
          {},
        closedMap:
          (CAF.storage.getClosedMap && CAF.storage.getClosedMap()) || {},
        logs,
      };

      return payload;
    };

    CAF.logs.downloadDebugJson = function () {
      try {
        const payload = CAF.logs.buildDebugPayload();
        const json = JSON.stringify(payload, null, 2);

        const runId = payload.runId || "run";
        const attempt = payload.attempt || 1;

        const stamp = new Date().toISOString().replace(/[:.]/g, "-");
        const filename = `CAF_DEBUG_${runId}_a${attempt}_${stamp}.json`;

        const blob = new Blob([json], {
          type: "application/json;charset=utf-8",
        });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();

        setTimeout(() => URL.revokeObjectURL(url), 1000);

        return true;
      } catch (e) {
        console.warn("Falha downloadDebugJson:", e);
        return false;
      }
    };

    // salva snapshot antes de navegar (para n√£o perder rastreio)
    CAF.logs.saveSnapshotBeforeUnload = function () {
      try {
        const payload = CAF.logs.buildDebugPayload();
        localStorage.setItem(CAF_DEBUG_SNAPSHOT_KEY, JSON.stringify(payload));
        return true;
      } catch (e) {
        return false;
      }
    };

    // bot√£o DEV flutuante (s√≥ aparece com DEV ligado) ‚Äî BLINDADO
    CAF.logs.ensureDevDownloadButton = function () {
      try {
        if (!(CAF && CAF.logs && CAF.logs.enabled === true)) return;

        const root = document.body || document.documentElement;
        if (!root) {
          requestAnimationFrame(CAF.logs.ensureDevDownloadButton);
          return;
        }

        // evita duplicar
        if (document.getElementById("cafDevDock")) return;

        // helper: aplica style com !important
        const setImp = (el, prop, val) => {
          try {
            el.style.setProperty(prop, val, "important");
          } catch (e) {}
        };

        // ===== Dock (container) =====
        const dock = document.createElement("div");
        dock.id = "cafDevDock";

        // style blindado contra CSS do site
        setImp(dock, "position", "fixed");
        setImp(dock, "right", "14px");
        setImp(dock, "bottom", "72px");
        setImp(dock, "z-index", "2147483647"); // m√°ximo pr√°tico
        setImp(dock, "display", "flex");
        setImp(dock, "gap", "8px");
        setImp(dock, "align-items", "center");
        setImp(dock, "padding", "0");
        setImp(dock, "margin", "0");
        setImp(dock, "background", "transparent");

        // ===== Bot√£o: Debug JSON =====
        const btnJson = document.createElement("button");
        btnJson.id = "cafDevDownloadBtn";
        btnJson.type = "button";
        btnJson.textContent = "‚¨áÔ∏è Debug JSON";
        btnJson.title = "Baixar log completo (DEV)";

        // style blindado
        setImp(btnJson, "all", "unset");
        setImp(btnJson, "box-sizing", "border-box");
        setImp(btnJson, "display", "inline-flex");
        setImp(btnJson, "align-items", "center");
        setImp(btnJson, "justify-content", "center");
        setImp(btnJson, "height", "32px");
        setImp(btnJson, "padding", "0 10px");
        setImp(btnJson, "border-radius", "10px");
        setImp(btnJson, "border", "1px solid #e5e7eb");
        setImp(btnJson, "background", "#111827");
        setImp(btnJson, "color", "#ffffff");
        setImp(btnJson, "font-family", "Arial, sans-serif");
        setImp(btnJson, "font-size", "12px");
        setImp(btnJson, "cursor", "pointer");
        setImp(btnJson, "box-shadow", "0 6px 16px rgba(0,0,0,.25)");

        btnJson.addEventListener("click", () => {
          try {
            CAF.logs.downloadDebugJson();
          } catch (e) {}
        });

        // ===== Bot√£o: Sair DEV =====
        const btnExit = document.createElement("button");
        btnExit.id = "cafDevExitBtn";
        btnExit.type = "button";
        btnExit.textContent = "üö™ Sair DEV";
        btnExit.title = "Desliga DEV, limpa auth e recarrega";

        // style blindado
        setImp(btnExit, "all", "unset");
        setImp(btnExit, "box-sizing", "border-box");
        setImp(btnExit, "display", "inline-flex");
        setImp(btnExit, "align-items", "center");
        setImp(btnExit, "justify-content", "center");
        setImp(btnExit, "height", "32px");
        setImp(btnExit, "padding", "0 10px");
        setImp(btnExit, "border-radius", "10px");
        setImp(btnExit, "border", "1px solid rgba(229,231,235,.6)");
        setImp(btnExit, "background", "rgba(255,255,255,.10)");
        setImp(btnExit, "color", "#ffffff");
        setImp(btnExit, "font-family", "Arial, sans-serif");
        setImp(btnExit, "font-size", "12px");
        setImp(btnExit, "cursor", "pointer");
        setImp(btnExit, "box-shadow", "0 6px 16px rgba(0,0,0,.25)");

        btnExit.addEventListener("click", () => {
          try {
            // 1) desligar logs (persist√™ncia)
            try {
              if (CAF && CAF.logs && CAF.logs.disable) CAF.logs.disable();
            } catch (e) {}

            // 2) limpar auth DEV (somente flags)
            try {
              sessionStorage.removeItem("CAF_DEV_ALLOWED");
            } catch (e) {}
            try {
              sessionStorage.removeItem("CAF_DEV_LOGS");
            } catch (e) {}

            // 3) limpar mock DEV (se estiver usando)
            try {
              localStorage.removeItem("CAF_DEV_MOCK_USER");
            } catch (e) {}

            // 4) remover dock e limpar console
            try {
              document.getElementById("cafDevDock")?.remove();
            } catch (e) {}
            try {
              console.clear();
            } catch (e) {}

            // 5) refresh
            try {
              location.reload();
            } catch (e) {}
          } catch (e) {}
        });

        dock.appendChild(btnJson);
        dock.appendChild(btnExit);

        // adiciona no body (ou documentElement)
        root.appendChild(dock);
      } catch (e) {}
    };

    // hook global: se DEV ligado, salvar snapshot em qualquer unload/navigation
    window.addEventListener("beforeunload", () => {
      try {
        if (CAF.logs && CAF.logs.enabled) {
          CAF.logs.saveSnapshotBeforeUnload();
        }
      } catch (e) {}
    });

    // ================================
    // üî• CONTROLE DE CONTINUIDADE ENTRE P√ÅGINAS
    // ================================
    const AUTO_STATE_KEY = "CAF_AUTO_RUNNING";
    const AUTO_PROCESSADAS_KEY = "CAF_AUTO_PROCESSADAS";
    const AUTO_CAFS_DONE_KEY = "CAF_AUTO_CAFS_DONE";
    const AUTO_PAGINA_KEY = "CAF_AUTO_PAGE";
    const AUTO_PERIODO_KEY = "CAF_AUTO_PERIODO";
    const AUTO_START_TIME_KEY = "CAF_AUTO_START_TIME";
    const AUTO_LOGS_KEY = "CAF_AUTO_LOGS";
    const EXPAND_CACHE = {};

    async function gerarHashScript() {
      const codigo = document.currentScript
        ? document.currentScript.textContent
        : "SCRIPT_DESCONHECIDO";

      const encoder = new TextEncoder();
      const data = encoder.encode(codigo);

      const hashBuffer = await crypto.subtle.digest("SHA-256", data);

      const hashArray = Array.from(new Uint8Array(hashBuffer));

      return hashArray.map((b) => b.toString(16).padStart(2, "0")).join("");
    }

    async function buscarEncoidsNC(cafid) {
      const url = `${location.origin}/agentes/caf_grid_detalhado.php?cafid=${cafid}&tipo=ncContadorCaf`;

      const res = await fetch(url, { credentials: "include" });
      const html = await res.text();

      const doc = new DOMParser().parseFromString(html, "text/html");

      const linhas = doc.querySelectorAll("#tabela tr");

      const lista = [];

      linhas.forEach((tr) => {
        const link = tr.querySelector("a[href*='encomenda_view.php']");

        if (!link) return;

        const href = link.getAttribute("href");

        const m = href.match(/encoid=(\d+)/);

        if (!m) return;

        lista.push({
          encoid: m[1],
          awb: link.innerText.trim(),
        });
      });

      return lista;
    }

    async function buscarUltimoStatusEncoid(encoid) {
      const url = `${location.origin}/agentes/encomenda_view.php?encoid=${encoid}`;

      const res = await fetch(url, { credentials: "include" });
      const html = await res.text();

      const doc = new DOMParser().parseFromString(html, "text/html");

      const tabela = doc.querySelector("table#borda");

      if (!tabela) return null;

      const linhas = tabela.querySelectorAll("tr");

      const ultima = linhas[linhas.length - 1];

      if (!ultima) return null;

      const tds = ultima.querySelectorAll("td");

      if (tds.length < 2) return null;

      return tds[1].innerText.trim();
    }

    async function validarNCsEstoqueBase(cafid) {
      LOG("üîé Validando NCs da CAF:", cafid);

      const encoids = await buscarEncoidsNC(cafid);

      if (!encoids.length) {
        LOG("‚úÖ CAF sem NC");
        return true;
      }

      for (const item of encoids) {
        const status = await buscarUltimoStatusEncoid(item.encoid);

        LOG("AWB:", item.awb, "Status:", status);

        if (!status || !status.toLowerCase().includes("estoque da base")) {
          LOG("‚ùå AWB ainda n√£o tratada:", item.awb);

          return false;
        }
      }

      LOG("‚úÖ Todas NC tratadas (Estoque da Base)");

      return true;
    }

    async function buscarDetalhesNC_CAF(cafid) {
      const resultado = [];

      const urlNC = `${location.origin}/agentes/caf_grid_detalhado.php?cafid=${cafid}&tipo=ncContadorCaf`;

      const res = await fetch(urlNC, { credentials: "include" });
      const html = await res.text();

      const doc = new DOMParser().parseFromString(html, "text/html");

      const linhas = doc.querySelectorAll("#tabela tr");

      const listaEncoids = [];

      linhas.forEach((tr) => {
        const link = tr.querySelector("a[href*='encomenda_view.php']");

        if (!link) return;

        const href = link.getAttribute("href");
        const m = href.match(/encoid=(\d+)/);

        if (!m) return;

        listaEncoids.push({
          encoid: m[1],
          awb: link.innerText.trim(),
        });
      });

      for (const item of listaEncoids) {
        try {
          const urlEnc = `${location.origin}/agentes/encomenda_view.php?encoid=${item.encoid}`;

          const r2 = await fetch(urlEnc, { credentials: "include" });
          const h2 = await r2.text();

          const d2 = new DOMParser().parseFromString(h2, "text/html");

          const tabelaHist = d2.querySelector("table#borda.cor_clara");

          if (!tabelaHist) continue;

          const trs = tabelaHist.querySelectorAll("tr");

          const ultima = trs[trs.length - 1];

          if (!ultima) continue;

          const tds = ultima.querySelectorAll("td");

          if (tds.length < 3) continue;

          resultado.push({
            caf: cafid,
            encoid: item.encoid,
            awb: item.awb,
            dataHora: tds[0].innerText.replace(/\n/g, " ").trim(),
            status: tds[1].innerText.trim(),
            usuario: tds[2].innerText.trim(),
          });
        } catch (e) {
          console.warn("Erro encoid", item.encoid, e);
        }
      }

      return resultado;
    }

    function getCafsProcessadas() {
      try {
        return JSON.parse(sessionStorage.getItem(AUTO_CAFS_DONE_KEY) || "[]");
      } catch (e) {
        return [];
      }
    }

    function marcarCAFProcessada(caf) {
      const lista = getCafsProcessadas();

      if (!lista.includes(caf)) {
        lista.push(caf);
        sessionStorage.setItem(AUTO_CAFS_DONE_KEY, JSON.stringify(lista));
      }
    }

    function jaProcessouCAF(caf) {
      const lista = getCafsProcessadas();
      return lista.includes(caf);
    }

    function pedirPeriodoAutomacao() {
      let periodo = sessionStorage.getItem(AUTO_PERIODO_KEY);

      if (periodo) return JSON.parse(periodo);

      const dataInicial = prompt("Informe a DATA INICIAL (dd/mm/aaaa):");
      if (!dataInicial) return null;

      const dataFinal = prompt("Informe a DATA FINAL (dd/mm/aaaa):");
      if (!dataFinal) return null;

      const obj = {
        dataInicial,
        dataFinal,
        limit: 100,
      };

      sessionStorage.setItem(AUTO_PERIODO_KEY, JSON.stringify(obj));

      return obj;
    }

    /* ========= utilit√°rios ========= */

    async function buscarAWBsDaCAF(caf) {
      try {
        const url = `https://ics.totalexpress.com.br/agentes/caf_awblist.php?cafid=${caf}`;

        const res = await fetch(url, { credentials: "include" });

        const html = await res.text();

        const parser = new DOMParser();
        const doc = parser.parseFromString(html, "text/html");

        const titulo = Array.from(doc.querySelectorAll("h1")).find(
          (h) => h.textContent.trim().toLowerCase() === "awb list",
        );

        if (!titulo) return "";

        const fontAWB = titulo.parentElement.querySelector("font");

        if (!fontAWB) return "";

        const awbs = fontAWB.innerHTML
          .split("<br>")
          .map((v) => v.trim())
          .filter((v) => v.length > 5);

        /* üî• AGORA VAI VIR:
           AMZB..., TXAQ..., SLAZ...
        */
        return awbs.join(", ");
      } catch (e) {
        console.error("Erro buscando AWB:", e);
        return "";
      }
    }

    function wait(ms) {
      return new Promise((resolve) => setTimeout(resolve, ms));
    }

    async function waitForSelector(selector, timeout = 15000) {
      const start = Date.now();
      while (!document.querySelector(selector)) {
        if (Date.now() - start > timeout) return null;
        await wait(400);
      }
      return document.querySelector(selector);
    }

    function obterLinhasValidas() {
      const rows = Array.from(document.querySelectorAll("table tbody tr"));
      return rows.filter((row) => {
        const tds = row.querySelectorAll("td");
        if (tds.length < 22) return false;
        return !!tds[0].querySelector("a[href*='caf_view.php']");
      });
    }

    function garantirPaginacao100() {
      const select = document.querySelector("select[name='limite']");

      if (!select) return;

      if (select.value !== "100") {
        LOG("‚ö†Ô∏è Pagina√ß√£o n√£o est√° em 100 ‚Äî ajustando automaticamente");

        select.value = "100";

        select.dispatchEvent(new Event("change", { bubbles: true }));
      }
    }

    function executarNoContextoDaPagina(code) {
      const s = document.createElement("script");
      s.textContent = `(${code})();`;
      document.documentElement.appendChild(s);
      s.remove();
    }

    function clicarCAFNaTela(numeroCAF) {
      const linhas = obterLinhasValidas();

      for (const row of linhas) {
        const link = row.querySelector(
          "a[onclick*='carregaEncomendasSelecionadas']",
        );

        if (!link) continue;

        const onclick = link.getAttribute("onclick") || "";

        if (onclick.includes(`(${numeroCAF},`)) {
          return link;
        }
      }

      return null;
    }

    function buscarUnidadeCAFNaTela(numeroCAF) {
      const linhas = obterLinhasValidas();

      for (const row of linhas) {
        const onclick = row.innerHTML;

        if (onclick.includes(`carregaEncomendasSelecionadas(${numeroCAF}`)) {
          const m = onclick.match(
            /carregaEncomendasSelecionadas\s*\(\s*\d+\s*,\s*(\d+)/,
          );

          if (m) {
            return m[1]; // unidade
          }
        }
      }

      return null;
    }

    function pegarCAFInicialDaTela() {
      const linhas = obterLinhasValidas();

      if (!linhas.length) {
        LOG("‚ùå Nenhuma linha v√°lida encontrada");
        return null;
      }

      for (const row of linhas) {
        const tds = row.querySelectorAll("td");

        // üî• ESTE √â O BOT√ÉO CERTO QUE ABRE O MODAL
        const btnEncerrar =
          tds[21]?.querySelector("a") || tds[22]?.querySelector("a");

        if (btnEncerrar) {
          LOG("‚úÖ Bot√£o ENCERRAR encontrado para contexto inicial");

          return btnEncerrar;
        }
      }

      LOG("‚ùå Nenhum bot√£o encerrar encontrado na tabela");
      return null;
    }

    /* ========= UI PROFISSIONAL ========= */

    const panel = document.createElement("div");

    panel.style = `
position:fixed;

left:8px;                 /* üî• dist√¢ncia da lateral */
right:8px;                /* üî• mant√©m dentro da tela */
bottom:8px;               /* üî• dist√¢ncia do rodap√© */

width:auto;               /* üî• evita estourar largura */
max-width:calc(100vw - 16px);

z-index:99999;

display:flex;
justify-content:space-between;
align-items:center;
gap:10px;

background:#ffffffee;
border:1px solid #ddd;    /* fica mais profissional */
border-radius:8px;        /* üî• apar√™ncia moderna */

padding:6px 10px;

font-family:Arial, sans-serif;
font-size:11px;

min-height:30px;
max-height:60px;

box-sizing:border-box;
overflow:hidden;

box-shadow:0 -2px 6px rgba(0,0,0,0.15);
`;

    // üî• N√ÉO COBRIR RODAP√â ICS (SAFE DOM READY)
    (function ajustarPaddingRodape() {
      if (!document.body) {
        requestAnimationFrame(ajustarPaddingRodape);
        return;
      }

      document.body.style.paddingBottom = "64px";
    })();

    /* ================= LEFT SIDE (STATUS) ================= */

    const leftBox = document.createElement("div");

    leftBox.style = `
display:flex;
align-items:center;
flex-wrap:wrap;
gap:6px;

flex:1 1 auto;
min-width:0;
flex:0 1 45%;
max-width:45vw;

overflow-x:hidden;
overflow-y:visible;

`;

    panel.appendChild(leftBox);

    /* t√≠tulo */
    const title = document.createElement("strong");
    title.innerText = "Automa√ß√£o CAF";
    title.style = `
font-size:12px;
white-space:nowrap;
margin-right:4px;
`;

    leftBox.appendChild(title);

    /* status inline */
    const statusDiv = document.createElement("div");

    statusDiv.style = `
display:flex;
align-items:center;
gap:6px;
flex-wrap:wrap;
`;
    const badgeElegiveis = criarBadge("Eleg√≠veis:0");
    const badgeZeradas = criarBadge("Zeradas:0");
    const badgeProcesso = criarBadge("0/0");

    badgeProcesso.style.cursor = "pointer";

    badgeProcesso.onclick = () => {
      const lista = getCafsProcessadas();

      if (!lista.length) {
        alert("Nenhuma CAF processada ainda.");
        return;
      }

      const texto = lista.join("\n");

      const box = document.createElement("div");

      box.style = `
        position:fixed;
        left:50%;
        top:50%;
        transform:translate(-50%,-50%);
        background:#fff;
        padding:10px;
        border:1px solid #ccc;
        z-index:999999;
        width:320px;
        border-radius:6px;
        box-shadow:0 4px 12px rgba(0,0,0,.3);
    `;

      const ta = document.createElement("textarea");

      ta.value = texto;
      ta.style = `
        width:100%;
        height:240px;
        font-family:monospace;
        font-size:12px;
    `;

      const btn = document.createElement("button");
      btn.innerText = "Fechar";
      btn.onclick = () => box.remove();

      box.appendChild(ta);
      box.appendChild(btn);

      document.body.appendChild(box);

      ta.select();
    };

    const badgeRest = criarBadge("Rest:0");
    const badgeMedio = criarBadge("M√©dio:‚Äî");
    const badgeDecorrido = criarBadge("Tempo:0s");
    const badgeCAFAtual = criarBadge("Aguardando");
    const badgeItens = criarBadge("Itens:0");

    leftBox.appendChild(statusDiv);

    /* ================= RIGHT SIDE (BOT√ïES) ================= */

    const rightBox = document.createElement("div");

    rightBox.style = `
display:flex;
align-items:center;
gap:6px;

flex-shrink:0;
overflow-x:auto;      /* üî• scroll horizontal suave */
overflow-y:hidden;
max-width:55vw;       /* üî• nunca passa metade da tela */
padding-bottom:2px;
`;

    panel.appendChild(rightBox);

    /* ===== BOT√ÉO PADR√ÉO ===== */

    function criarBtn(txt, cor) {
      const b = document.createElement("button");

      b.innerText = txt;

      b.style = `
        padding:4px 10px;          /* üî• controla altura automaticamente */
        font-size:11px;
        line-height:1.2;

        border:none;
        border-radius:6px;
        cursor:pointer;

        color:#fff;
        background:${cor};

        display:flex;              /* üî• melhor que inline-flex aqui */
        align-items:center;
        justify-content:center;

        white-space:nowrap;
        flex-shrink:0;
    `;

      rightBox.appendChild(b);

      return b;
    }

    function criarBadge(label) {
      const box = document.createElement("div");

      box.style = `
        height:20px;
        padding:0 8px;
        border-radius:4px;
        background:#f1f3f5;
        color:#111;
        font-size:11px;

        display:flex;
        align-items:center;
        white-space:nowrap;
    `;

      box.innerText = label;

      statusDiv.appendChild(box);

      return box;
    }

    /* ===== BOT√ïES ===== */
    const btnAnalisePlanilha = criarBtn("Resumo do processamento", "#fd7e14");
    const btnSelecionarPlanilha = criarBtn("Carregar Planilha", "#6610f2");
    const btnStart = criarBtn("Encerrar CAF's Normais", "#28a745");
    const btnStartZeradas = criarBtn("Encerrar CAF's Zeradas", "#6c757d");
    const btnPause = criarBtn("Pause", "#ffc107");
    btnPause.style.color = "#111";
    const btnStop = criarBtn("Stop", "#dc3545");
    const btnClearStorage = criarBtn("Limpar Storage", "#343a40");

    /* input planilha */
    const inputPlanilhaLocal = document.createElement("input");
    inputPlanilhaLocal.type = "file";
    inputPlanilhaLocal.accept = ".xlsx,.xls,.csv";
    inputPlanilhaLocal.style.display = "none";

    document.body.appendChild(inputPlanilhaLocal);
    document.body.appendChild(panel);

    // ======================================
    // üîí BOOT LOCK ‚Äî trava at√© validar acesso (usu√°rio do site ou master)
    // ======================================
    (async function () {
      // trava imediatamente
      CAF.ui.setLocked(true, "Verificando usu√°rio e autoriza√ß√£o...");

      const r = await CAF.security.ensureAccess();

      if (r && r.ok) {
        CAF.ui.setLocked(false, "");
      } else if (r && r.reason === "NO_USER") {
        CAF.ui.setLocked(
          true,
          "Usu√°rio n√£o identificado no site.\n\nFa√ßa login no sistema (onde aparece 'Usu√°rio: ...') ou use o MASTER (Shift, Shift, D).",
        );
      } else if (r && r.reason === "NOT_ALLOWED") {
        CAF.ui.setLocked(
          true,
          `Usu√°rio "${r.user}" n√£o est√° autorizado.\n\nGentileza acessar a plataforma com um usu√°rio autorizado.`,
        );
      } else {
        CAF.ui.setLocked(
          true,
          "Falha ao validar autoriza√ß√£o (Worker/Conex√£o).\n\nTente novamente ou use o MASTER (Shift, Shift, D).",
        );
      }
    })();

    /* ========= estado ========= */
    //let totalElegiveis = contarElegiveis();
    let totalElegiveis = 0; // agora vem da planilha
    let totalZeradasGlobal = 0;
    let processadas = 0;
    let logsProcessamento = []; // {caf, ts, step, result, detail}
    const itensPorCAF = {}; // { cafNumber: [ {awb,...}, ... ] }
    const capturasPreliminares = {}; // { cafNumber: { expectedItems: n } }

    let currentCAF = null;
    let isPaused = false;
    let stopRequested = false;
    let PLANILHA_CARREGADA = null;
    let MAPA_PLANILHA_CACHE = null; // üî• cache da classifica√ß√£o da planilha
    /* =========================
   CONTROLE PAGINA√á√ÉO CAF
========================= */

    let pageAtual = 0; // üî• sempre inicia na primeira p√°gina
    const LIMIT_PAGINA = 100; // padr√£o do sistema

    // üîÅ tenta recuperar planilha ap√≥s reload/pagina√ß√£o
    try {
      const cachePlanilha = sessionStorage.getItem("CAF_PLANILHA");

      if (cachePlanilha) {
        PLANILHA_CARREGADA = JSON.parse(cachePlanilha);

        LOG("‚ôªÔ∏è Planilha restaurada automaticamente da sess√£o");
      }
    } catch (e) {
      console.warn("Falha ao restaurar planilha:", e);
    }
    // tempo/estimativa
    let inicioProcessamento = null;
    let cafDurations = []; // segundos por caf

    function atualizarContadorUI() {
      let totalZeradas = 0;
      let totalNormais = 0;

      if (PLANILHA_CARREGADA && PLANILHA_CARREGADA.length) {
        if (!MAPA_PLANILHA_CACHE) {
          MAPA_PLANILHA_CACHE = classificarCAFPlanilha(PLANILHA_CARREGADA);
        }

        const mapaCAF = MAPA_PLANILHA_CACHE;

        for (const caf in mapaCAF) {
          if (mapaCAF[caf].tipo === "zerada") {
            totalZeradas++;
          } else {
            totalNormais++;
          }
        }

        totalElegiveis = totalNormais;
        totalZeradasGlobal = totalZeradas;
      }

      atualizarProgressoUI();
    }

    function formatTempoSegundos(sec) {
      if (!isFinite(sec) || sec <= 0) return "0s";
      const h = Math.floor(sec / 3600);
      const m = Math.floor((sec % 3600) / 60);
      const s = Math.floor(sec % 60);
      if (h > 0) return `${h}h ${m}m ${s}s`;
      if (m > 0) return `${m}m ${s}s`;
      return `${s}s`;
    }
    function atualizarProgressoUI() {
      const total = totalElegiveis;
      const restante = Math.max(0, total - processadas);

      const soma = cafDurations.reduce((a, b) => a + b, 0);
      const media = cafDurations.length ? soma / cafDurations.length : null;

      const estimadoTotal = media ? media * total : null;
      const estimadoRestante = media ? media * restante : null;

      const decorrido = inicioProcessamento
        ? (Date.now() - inicioProcessamento) / 1000
        : 0;

      badgeElegiveis.innerText = `Eleg√≠veis:${totalElegiveis}`;
      badgeZeradas.innerText = `Zeradas:${totalZeradasGlobal || 0}`;
      badgeProcesso.innerText = `${processadas}/${total}`;
      badgeRest.innerText = `Rest:${restante}`;
      badgeMedio.innerText = `M√©dio:${media ? formatTempoSegundos(media) : "‚Äî"}`;
      badgeDecorrido.innerText = `Dec:${formatTempoSegundos(decorrido)}`;
      badgeCAFAtual.innerText = currentCAF ? `CAF:${currentCAF}` : `Aguardando`;
      let totalAWB = 0;

      for (const caf in itensPorCAF) {
        totalAWB += itensPorCAF[caf].length;
      }

      badgeItens.innerText = `Itens:${totalAWB}`;
    }

    atualizarContadorUI();

    /* ========= SheetJS loader ========= */
    function loadXLSX() {
      return new Promise((resolve) => {
        if (window.XLSX) return resolve(window.XLSX);
        const s = document.createElement("script");
        s.src =
          "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js";
        s.onload = () => resolve(window.XLSX);
        s.onerror = () => resolve(null);
        document.head.appendChild(s);
      });
    }

    /* ========= coleta itens Modal 2 ========= */
    function coletarItensModal2_directTable() {
      const tabela = document.querySelector("#tabela");
      if (!tabela) return [];
      const tbody = tabela.querySelector("tbody") || tabela;
      const linhas = Array.from(tbody.querySelectorAll("tr")).filter((l) => {
        const tds = l.querySelectorAll("td");
        return tds.length >= 6 && !!l.querySelector("input[type='checkbox']");
      });

      const itens = [];
      for (const row of linhas) {
        const tds = row.querySelectorAll("td");
        if (tds.length < 6) continue;
        const awb = (tds[0].innerText || "").trim();
        const embarcador = (tds[1].innerText || "").trim();
        const cidade = (tds[2].innerText || "").trim();
        const status = (tds[3].innerText || "").trim();
        const dataStatus = (tds[4].innerText || "").trim();
        itens.push({ awb, embarcador, cidade, status, dataStatus });
      }
      return itens;
    }

    function coletarItensModal2() {
      const content = document.querySelector("#nyroModalContent");
      if (content) {
        const tabela = content.querySelector("#tabela");
        if (tabela) {
          const tbody = tabela.querySelector("tbody") || tabela;
          const linhas = Array.from(tbody.querySelectorAll("tr")).filter(
            (l) => {
              const tds = l.querySelectorAll("td");
              return (
                tds.length >= 6 && !!l.querySelector("input[type='checkbox']")
              );
            },
          );
          const itens = [];
          for (const row of linhas) {
            const tds = row.querySelectorAll("td");
            const awb = (tds[0].innerText || "").trim();
            const embarcador = (tds[1].innerText || "").trim();
            const cidade = (tds[2].innerText || "").trim();
            const status = (tds[3].innerText || "").trim();
            const dataStatus = (tds[4].innerText || "").trim();
            itens.push({ awb, embarcador, cidade, status, dataStatus });
          }
          return itens;
        }
      }
      return coletarItensModal2_directTable();
    }

    /* ========= logs ========= */
    function registrarLogObj(caf, step, result, detail = "") {
      const data = new Date();
      const ts = data.toLocaleString("pt-BR");
      const runId = CAF.engine.getRunId ? CAF.engine.getRunId() : "";
      const attempt = CAF.engine.getAttempt ? CAF.engine.getAttempt() : 1;
      const eventId = CAF.engine.nextEventId ? CAF.engine.nextEventId() : 0;

      // üî• LOG INTERNO ORIGINAL (N√ÉO ALTERADO)
      logsProcessamento.push({
        caf,
        ts,
        step,
        result,
        detail,
        runId,
        attempt,
        eventId,
        scriptHash: window.__CAF_SCRIPT_HASH || "N/A",
      });

      // üî• NOVO BLOCO LOGGER ESTRUTURADO (ETAPA 4)
      try {
        CAF.logs.step({
          caf,
          ts,
          step,
          result,
          detail,
        });
      } catch (e) {
        console.warn("CAF.logs.step erro", e);
      }

      // üî• SALVA ENTRE P√ÅGINAS (mantido)
      try {
        sessionStorage.setItem(
          AUTO_LOGS_KEY,
          JSON.stringify(logsProcessamento),
        );
      } catch (e) {}

      // üîê CONSOLE LOG SOMENTE SE DEV MODE ATIVO
      if (CAF.logs && CAF.logs.enabled) {
        console.log(
          `[LOG] ${ts} - run:${runId} a:${attempt} e:${eventId} - CAF ${caf} - ${step} - ${result} ${detail ? "- " + detail : ""}`,
        );
      }

      // ‚úÖ ETAPA 17 ‚Äî marca CAF encerrada SOMENTE no sucesso final
      try {
        const isFinalSuccess =
          step === "Resultado Final" && result === "Processada com sucesso";

        if (isFinalSuccess) {
          const meta = {
            ts,
            iso: new Date().toISOString(),
            step,
            detail,
            runId,
            attempt,
            eventId,
          };

          CAF.storage.markClosed(caf, meta);

          // üîé DEV MODE: mostra o que foi gravado
          if (CAF.logs && CAF.logs.enabled) {
            console.log("‚úÖ CAF marcada como encerrada (FINAL):", caf, meta);
          }
        }
      } catch (e) {}
    }

    function baixarLogTxt() {
      if (!logsProcessamento.length) {
        console.log("[TMK] Sem logs para baixar.");
        return;
      }
      const lines = logsProcessamento.map(
        (l) => `${l.ts} - CAF ${l.caf} - ${l.step} - ${l.result} - ${l.detail}`,
      );
      const conteudo = lines.join("\n");
      const blob = new Blob([conteudo], { type: "text/plain;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `log_caf_processamento_${new Date().toISOString().slice(0, 19).replace(/[:T]/g, "-")}.txt`;
      a.click();
      URL.revokeObjectURL(url);
    }

    async function baixarLogXlsx() {
      if (!logsProcessamento.length) {
        console.log("[TMK] Sem logs para baixar (XLSX).");
        return;
      }
      const XLSX = await loadXLSX();
      const filename = `log_caf_processamento_${new Date().toISOString().slice(0, 19).replace(/[:T]/g, "-")}`;
      const aoa = [["CAF", "Timestamp", "Etapa", "Resultado", "Detalhe"]];
      for (const l of logsProcessamento)
        aoa.push([l.caf, l.ts, l.step, l.result, l.detail]);
      if (XLSX) {
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(aoa);
        XLSX.utils.book_append_sheet(wb, ws, "Logs");
        const wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
        const blob = new Blob([wbout], { type: "application/octet-stream" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${filename}.xlsx`;
        a.click();
        URL.revokeObjectURL(url);
      } else {
        const csv = aoa
          .map((r) =>
            r.map((c) => `"${String(c).replace(/"/g, '""')}"`).join(","),
          )
          .join("\n");
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${filename}.csv`;
        a.click();
        URL.revokeObjectURL(url);
      }
    }

    /* ========= export itens por CAF ========= */
    async function exportarItensXlsx() {
      const rows = [
        [
          "CAF",
          "AWB",
          "Embarcador",
          "Cidade",
          "Status Atual",
          "Data √öltimo Status",
        ],
      ];
      for (const caf of Object.keys(itensPorCAF)) {
        const itens = itensPorCAF[caf] || [];
        for (const it of itens) {
          rows.push([
            caf,
            it.awb,
            it.embarcador,
            it.cidade,
            it.status,
            it.dataStatus,
          ]);
        }
      }
      if (rows.length <= 1) {
        alert("Nenhum item coletado para exportar.");
        return;
      }
      const XLSX = await loadXLSX();
      const filename = `itens_modal2_${new Date().toISOString().slice(0, 19).replace(/[:T]/g, "-")}`;
      if (XLSX) {
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(rows);
        XLSX.utils.book_append_sheet(wb, ws, "ItensModal2");
        const wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
        const blob = new Blob([wbout], { type: "application/octet-stream" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${filename}.xlsx`;
        a.click();
        URL.revokeObjectURL(url);
      } else {
        const csv = rows
          .map((r) =>
            r.map((c) => `"${String(c).replace(/"/g, '""')}"`).join(","),
          )
          .join("\n");
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${filename}.csv`;
        a.click();
        URL.revokeObjectURL(url);
      }
    }
    // btnExportItems.addEventListener("click", async () => { btnExportItems.disabled = true; btnExportItems.innerText = "Exportando..."; await exportarItensXlsx(); btnExportItems.disabled = false; btnExportItems.innerText = "Exportar itens (XLSX/CSV)"; });

    /* ========= export estat√≠sticas ========= */
    async function exportarStats() {
      const total = totalElegiveis;
      const processed = processadas;
      const soma = cafDurations.reduce((a, b) => a + b, 0);
      const media = cafDurations.length ? soma / cafDurations.length : 0;
      const tempoDecorrido = inicioProcessamento
        ? Math.round((Date.now() - inicioProcessamento) / 1000)
        : 0;

      const aoa = [
        ["M√©trica", "Valor"],
        ["CAF eleg√≠veis (no in√≠cio)", total],
        ["CAF processadas", processed],
        ["Tempo m√©dio por CAF (s)", media.toFixed(2)],
        ["Tempo decorrido (s)", tempoDecorrido],
        ["Tempo decorrido (format)", formatTempoSegundos(tempoDecorrido)],
        ["Data export", new Date().toLocaleString("pt-BR")],
      ];

      const XLSX = await loadXLSX();
      const filename = `estatisticas_processamento_${new Date().toISOString().slice(0, 19).replace(/[:T]/g, "-")}`;
      if (XLSX) {
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(aoa);
        XLSX.utils.book_append_sheet(wb, ws, "Stats");
        const wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
        const blob = new Blob([wbout], { type: "application/octet-stream" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${filename}.xlsx`;
        a.click();
        URL.revokeObjectURL(url);
      } else {
        const csv = aoa
          .map((r) =>
            r.map((c) => `"${String(c).replace(/"/g, '""')}"`).join(","),
          )
          .join("\n");
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${filename}.csv`;
        a.click();
        URL.revokeObjectURL(url);
      }
    }
    // btnExportStats.addEventListener("click", async () => { btnExportStats.disabled = true; btnExportStats.innerText = "Exportando..."; await exportarStats(); btnExportStats.disabled = false; btnExportStats.innerText = "Exportar estat√≠sticas (XLSX/CSV)"; });

    /* ========= pause/stop ========= */
    function togglePause() {
      isPaused = !isPaused;
      btnPause.innerText = isPaused ? "Retomar" : "Pausar";
      btnPause.style.background = isPaused ? "#17a2b8" : "#ffc107";
    }
    function requestStop() {
      stopRequested = true;
      btnStart.disabled = false;
      btnStart.style.background = "#28a745";
      btnStart.innerText = "Start Processamento CAF";
      btnPause.disabled = true;
      btnPause.style.opacity = 0.6;
      btnStop.disabled = true;
      btnStop.style.opacity = 0.6;
    }
    async function checkPauseAndStop() {
      while (isPaused && !stopRequested) {
        await wait(400);
      }
      return stopRequested;
    }
    btnPause.addEventListener("click", async () => {
      if (!(await CAF.security.guard("pause"))) return;
      togglePause();
    });
    btnStop.addEventListener("click", async () => {
      if (!(await CAF.security.guard("stop"))) return;

      if (confirm("Deseja realmente encerrar o processo em andamento?")) {
        requestStop();
        registrarLogObj(
          currentCAF || "N/A",
          "Processo",
          "Encerrado pelo usu√°rio",
          "StopRequested",
        );
      }
    });

    /* ========= detectar etapa ========= */
    function detectarEtapaModal() {
      const wrapper = document.querySelector("#nyroModalWrapper");
      const content = document.querySelector("#nyroModalContent");
      if (!wrapper || !content) return 0;
      const text = content.innerText || "";
      if (
        text.includes("Encerrar Selecionadas") ||
        /checkbox/i.test(content.innerHTML)
      )
        return 2;
      if (text.match(/Finalizar\s+CAF|Finalizar Caf|Finalizar/)) return 3;
      if (
        content.querySelector("a.button_baixa_caf") &&
        content.querySelector("a.button_baixa_caf").innerText &&
        content
          .querySelector("a.button_baixa_caf")
          .innerText.includes("Encerrar")
      )
        return 1;
      if (wrapper.querySelector(".nyroModalClose")) return 4;
      return 0;
    }

    // ========= Fun√ß√£o de scroll autom√°tico (para carregar bot√µes e itens dos modais) =========
    async function autoScrollModal() {
      const content = document.querySelector("#nyroModalContent");
      if (!content) return;
      for (let i = 0; i < 8; i++) {
        content.scrollTop = content.scrollHeight;
        await wait(300);
      }
    }

    /* ========= ajuda para calcular timeout din√¢mico ========= */
    function calcularTimeoutPorItens(itemCount) {
      // base + extra por item (em ms)
      const base = 1000; // m√≠nimo
      const perItem = 150; // ms por item (ajust√°vel)
      const calculated = base + itemCount * perItem;
      // clamp: entre 1000ms e 30s
      return Math.max(1000, Math.min(30000, calculated));
    }

    /* ========= modais ========= */
    async function processarModal1(caf) {
      // üî• comportamento igual vers√£o 10
      await wait(800);

      const btn = document.querySelector(
        "#nyroModalContent a.button_baixa_caf",
      );

      if (!btn) {
        registrarLogObj(
          caf,
          "Modal 1",
          "Falha",
          "Bot√£o Encerrar n√£o encontrado (modo v10)",
        );

        return { skipped: false, ok: false };
      }

      try {
        btn.click();

        registrarLogObj(caf, "Modal 1", "OK", "Clique realizado (modo v10)");

        await wait(1000);

        return { skipped: false, ok: true };
      } catch (e) {
        registrarLogObj(caf, "Modal 1", "Falha", e.message);

        return { skipped: false, ok: false };
      }
    }

    async function processarModal2(caf) {
      const etapa = detectarEtapaModal();
      if (etapa >= 3) {
        registrarLogObj(
          caf,
          "Modal 2",
          "Pulado",
          "Detectado modal atual: " + etapa,
        );
        return { skipped: true };
      }

      const tabela = await waitForSelector(
        "#nyroModalContent table, #tabela",
        15000,
      );

      if (!tabela) {
        registrarLogObj(
          caf,
          "Modal 2",
          "Falha",
          "Tabela de checkboxes n√£o encontrada",
        );
        return { skipped: false, ok: false, reason: "tabela_nao_encontrada" };
      }

      // üî• NOVO ‚Äî esperar linhas reais carregarem (AJAX)
      let linhasCarregadas = false;

      for (let i = 0; i < 60; i++) {
        // ~18s m√°ximo
        const linhas = tabela.querySelectorAll("tbody tr");

        if (linhas && linhas.length > 0) {
          linhasCarregadas = true;
          break;
        }

        await wait(300);
      }

      if (!linhasCarregadas) {
        registrarLogObj(
          caf,
          "Modal 2",
          "Aguardando",
          "Tabela presente mas sem linhas, aguardando AJAX...",
        );
        await wait(2000);

        // üî• retry autom√°tico da pr√≥pria fun√ß√£o
        return await processarModal2(caf);
      }

      // for√ßa scroll e espera din√¢mica baseada em qtd de itens (se j√° capturada preliminarmente usa isto)
      await autoScrollModal();
      await wait(400);

      // tenta pegar n√∫mero de itens pelo DOM (melhor fonte)
      let itens = coletarItensModal2();
      let itemCount = itens && itens.length ? itens.length : 0;
      // se n√£o achou, tenta checar capturas pr√©vias (quando carregaEncomendasSelecionadas foi clicada)
      if (
        !itemCount &&
        capturasPreliminares[caf] &&
        capturasPreliminares[caf].expectedItems
      ) {
        itemCount = capturasPreliminares[caf].expectedItems;
      }

      // üî• NOVO ‚Äî tempo m√≠nimo para AJAX independente da qtd de itens
      const TEMPO_BASE_AJAX = 2500;

      // tempo inteligente continua existindo
      const esperaDinamica = calcularTimeoutPorItens(itemCount);

      // espera o maior entre:
      // - tempo base do sistema
      // - tempo por quantidade de itens
      await wait(Math.max(TEMPO_BASE_AJAX, esperaDinamica));

      // recolhe itens novamente (ap√≥s espera)
      itens = coletarItensModal2();
      if (itens && itens.length > 0) {
        itensPorCAF[caf] = itens;
        for (const item of itens) {
          registrarLogObj(
            caf,
            "Itens Modal 2",
            "OK",
            `AWB: ${item.awb} | Embarcador: ${item.embarcador} | Cidade: ${item.cidade} | Status: ${item.status} | Data: ${item.dataStatus}`,
          );
        }
      } else {
        registrarLogObj(
          caf,
          "Modal 2",
          "Aguardando",
          "Tabela vazia, aguardando AJAX...",
        );
        await wait(2000);
        return await processarModal2(caf); // retry autom√°tico
      }

      // checa se h√° checkboxes e se est√£o todos marcados
      const linhas = Array.from(tabela.querySelectorAll("tr"));
      let tudoMarcado = true;
      for (const linha of linhas) {
        const colunas = linha.querySelectorAll("td");
        if (!colunas || colunas.length === 0) continue;
        const checkbox = colunas[colunas.length - 1]?.querySelector(
          "input[type='checkbox']",
        );
        if (checkbox && !checkbox.checked) {
          tudoMarcado = false;
          break;
        }
      }

      if (!tudoMarcado) {
        registrarLogObj(
          caf,
          "Modal 2",
          "Falha",
          "Existem checkboxes desmarcados",
        );
        return { skipped: false, ok: false, reason: "checkbox_desmarcado" };
      }

      // espera at√© bot√£o aparecer (mais tentativas quando muitos itens)
      let btnEncSel = null;

      const maxLoops = Math.ceil(Math.max(8, itemCount / 5));

      for (let i = 0; i < Math.min(60, maxLoops * 8); i++) {
        const modalContent = document.querySelector("#nyroModalContent");

        if (modalContent) {
          btnEncSel = modalContent.querySelector("#encerrar_selecionadas");
        }

        // üî• garante que n√£o pegou bot√£o antigo invis√≠vel
        if (btnEncSel && btnEncSel.offsetParent !== null) {
          break;
        }

        await wait(200);
      }

      if (!btnEncSel) {
        registrarLogObj(
          caf,
          "Modal 2",
          "Falha",
          "Bot√£o Encerrar Selecionadas n√£o encontrado",
        );
        return {
          skipped: false,
          ok: false,
          reason: "btn_encerrar_selecionadas_nao_encontrado",
        };
      }

      await autoScrollModal();
      await wait(800);

      try {
        btnEncSel.click();
        // espera maior proporcional ao tamanho
        await wait(Math.max(1200, calcularTimeoutPorItens(itemCount)));
        registrarLogObj(caf, "Modal 2", "OK", "Encerrar Selecionadas clicado");
        return { skipped: false, ok: true };
      } catch (e) {
        registrarLogObj(caf, "Modal 2", "Falha", e.message);
        return { skipped: false, ok: false, reason: e.message };
      }
    }

    async function processarModal3(caf) {
      const etapa = detectarEtapaModal();

      if (etapa >= 4) {
        registrarLogObj(
          caf,
          "Modal 3",
          "Pulado",
          "Detectado modal atual: " + etapa,
        );
        return { skipped: true };
      }

      // tenta estimar quantos items tem para calcular espera (usa itensPorCAF)
      const itemCount =
        itensPorCAF[caf] && itensPorCAF[caf].length
          ? itensPorCAF[caf].length
          : capturasPreliminares[caf]
            ? capturasPreliminares[caf].expectedItems
            : 0;

      const espera = calcularTimeoutPorItens(itemCount);

      const maxTent = 60;
      let t = 0;
      let btnFinalizar = null;

      while (t < maxTent && !btnFinalizar) {
        const modalContent = document.querySelector("#nyroModalContent");

        if (modalContent) {
          const candidato = modalContent.querySelector("#finalizar_caf");

          // üî• garante que pegou o bot√£o VIS√çVEL do modal atual
          if (candidato && candidato.offsetParent !== null) {
            btnFinalizar = candidato;
            break;
          }
        }

        await wait(200);
        t++;

        if (t === 10) {
          await wait(Math.min(espera, 3000));
        }
      }

      if (!btnFinalizar) {
        registrarLogObj(
          caf,
          "Modal 3",
          "Falha",
          "Bot√£o Finalizar Caf n√£o encontrado",
        );
        return {
          skipped: false,
          ok: false,
          reason: "btn_finalizar_nao_encontrado",
        };
      }

      // üî• SCROLL CORRETO DO NYROMODAL
      await autoScrollModal();
      await wait(400);

      try {
        // garante que o bot√£o esteja dentro do viewport do modal
        if (btnFinalizar.scrollIntoView) {
          btnFinalizar.scrollIntoView({ block: "center" });
        }

        await wait(300);

        btnFinalizar.click();

        await wait(800);

        registrarLogObj(caf, "Modal 3", "OK", "Finalizar clicado");

        return { skipped: false, ok: true };
      } catch (e) {
        registrarLogObj(caf, "Modal 3", "Falha", e.message);

        return { skipped: false, ok: false, reason: e.message };
      }
    }

    async function processarModal4_tryClose(caf) {
      let fechado = false;
      const tentativasMax = 30;
      let tentativas = 0;
      while (!fechado && tentativas < tentativasMax && !stopRequested) {
        tentativas++;
        const botaoFechar =
          document.querySelector("#nyroModalWrapper a.button_baixa_caf") ||
          document.querySelector("#nyroModalWrapper .nyroModalClose") ||
          document.querySelector("#nyroModalWrapper a[onclick*='fecharModal']");
        if (botaoFechar) {
          try {
            botaoFechar.click();
          } catch (e) {}
        } else if (typeof fecharModal === "function") {
          try {
            fecharModal();
          } catch (e) {}
        } else {
          const wrapper = document.querySelector("#nyroModalWrapper");
          if (wrapper) {
            try {
              wrapper.querySelector(".nyroModalClose")?.click();
            } catch (e) {}
          }
        }
        await wait(300);
        fechado = !document.querySelector("#nyroModalWrapper");
      }
      if (fechado) {
        registrarLogObj(caf, "Modal 4", "OK", "Fechado com sucesso");
        return { ok: true };
      }
      registrarLogObj(caf, "Modal 4", "Falha", "N√£o conseguiu fechar modal");
      return { ok: false, reason: "nao_fechou" };
    }

    async function esperarNovaTela() {
      await wait(1200);
    }

    /* ========= controlador de modais ========= */
    async function processarFluxoModaisParaCAF(numeroCAF) {
      const wrapper = await waitForSelector("#nyroModalWrapper", 4000);
      if (!wrapper) {
        registrarLogObj(numeroCAF, "Fluxo", "Falha", "Modal wrapper n√£o abriu");
        return { ok: false };
      }

      if (await checkPauseAndStop()) return { ok: false, stop: true };
      const m1 = await processarModal1(numeroCAF);
      if (m1 && m1.ok === false && !m1.skipped)
        return { ok: false, reason: m1.reason };
      await esperarNovaTela();

      if (await checkPauseAndStop()) return { ok: false, stop: true };
      const m2 = await processarModal2(numeroCAF);
      if (m2 && m2.ok === false && !m2.skipped)
        return { ok: false, reason: m2.reason };
      await esperarNovaTela();

      if (await checkPauseAndStop()) return { ok: false, stop: true };
      const m3 = await processarModal3(numeroCAF);
      if (m3 && m3.ok === false && !m3.skipped)
        return { ok: false, reason: m3.reason };
      await esperarNovaTela();

      if (await checkPauseAndStop()) return { ok: false, stop: true };

      // üî• VERIFICA PELO CONTROLE INTERNO DO SCRIPT
      const aindaTemElegivel = processadas + 1 < totalElegiveis;

      if (aindaTemElegivel) {
        registrarLogObj(
          numeroCAF,
          "Fluxo",
          "Continuar",
          `Ainda existem CAFs eleg√≠veis (${processadas + 1}/${totalElegiveis}), n√£o fecha modal final`,
        );

        await wait(700);

        return { ok: true, keepWindow: true };
      }

      const fechou = await processarModal4_tryClose(numeroCAF);
      if (!fechou.ok) {
        return { ok: false, reason: "fechar_modal_falhou" };
      }
      let tent = 0;
      while (document.querySelector("#nyroModalWrapper") && tent < 30) {
        await wait(200);
        tent++;
      }
      return { ok: true };
    }

    async function processarFluxoCAFZerada(numeroCAF) {
      const wrapper = await waitForSelector("#nyroModalWrapper", 4000);
      if (!wrapper) {
        registrarLogObj(numeroCAF, "Fluxo Zerada", "Falha", "Modal n√£o abriu");
        return { ok: false };
      }

      // Modal 1
      const m1 = await processarModal1(numeroCAF);
      if (m1 && m1.ok === false && !m1.skipped) {
        return { ok: false, reason: m1.reason };
      }

      await esperarNovaTela();

      // Pula modal 2

      const m3 = await processarModal3(numeroCAF);
      if (m3 && m3.ok === false && !m3.skipped) {
        return { ok: false, reason: m3.reason };
      }

      await esperarNovaTela();

      const fechou = await processarModal4_tryClose(numeroCAF);

      return { ok: fechou.ok };
    }

    // ======================================
    // üß† ENGINE EXPORT (ETAPA 5)
    // ======================================

    CAF.engine = CAF.engine || {};

    // modais
    CAF.engine.processarModal1 = processarModal1;
    CAF.engine.processarModal2 = processarModal2;
    CAF.engine.processarModal3 = processarModal3;
    CAF.engine.processarModal4_tryClose = processarModal4_tryClose;

    // fluxos
    CAF.engine.processarFluxoModaisParaCAF = processarFluxoModaisParaCAF;
    CAF.engine.processarFluxoCAFZerada = processarFluxoCAFZerada;

    // timers/helpers relacionados ao fluxo
    CAF.engine.esperarNovaTela = esperarNovaTela;
    CAF.engine.autoScrollModal = autoScrollModal;
    CAF.engine.detectarEtapaModal = detectarEtapaModal;
    CAF.engine.calcularTimeoutPorItens = calcularTimeoutPorItens;

    async function carregarPlanilhaLocal(arquivo) {
      LOG("===== INICIO carregarPlanilhaLocal =====");

      const XLSX = await loadXLSX();

      if (!XLSX) {
        LOG("‚ùå XLSX n√£o carregado");
        return [];
      }

      return new Promise((resolve) => {
        const reader = new FileReader();

        reader.onload = function (e) {
          try {
            const data = new Uint8Array(e.target.result);

            const workbook = XLSX.read(data, { type: "array" });

            LOG("Sheets encontradas:", workbook.SheetNames);

            const sheet = workbook.Sheets[workbook.SheetNames[0]];

            const linhas = XLSX.utils.sheet_to_json(sheet, { header: 1 });

            LOG("TOTAL LINHAS PLANILHA LOCAL:", linhas.length);

            PLANILHA_CARREGADA = linhas;
            MAPA_PLANILHA_CACHE = null;

            // üß† salva planilha para sobreviver pagina√ß√£o
            try {
              sessionStorage.setItem("CAF_PLANILHA", JSON.stringify(linhas));
              LOG("üíæ Planilha salva em sessionStorage");
            } catch (e) {
              console.warn("Falha ao salvar planilha:", e);
            }

            resolve(linhas);
          } catch (err) {
            console.error("‚ùå ERRO lendo planilha local:", err);
            resolve([]);
          }
        };

        reader.readAsArrayBuffer(arquivo);
      });
    }

    function classificarCAFPlanilha(linhas) {
      const mapa = {};

      const limparInt = (txt) => Number(String(txt || "").replace(/\D+/g, ""));

      const normalizarEvolucao = (val) => {
        if (val === undefined || val === null || val === "") return 0;

        // üî• Excel retorna porcentagem como decimal (1 = 100%)
        if (typeof val === "number") {
          if (val <= 1) return val * 100;
          return val;
        }

        return (
          parseFloat(String(val).replace("%", "").replace(",", ".").trim()) || 0
        );
      };

      // pula cabe√ßalho
      for (let i = 1; i < linhas.length; i++) {
        const row = linhas[i];
        if (!row || !row.length) continue;

        const caf = String(row[0] || "").trim();
        if (!caf) continue;

        // ‚úÖ √≠ndices REAIS da sua planilha
        const qtdeTotal = limparInt(row[7]); // QTDE Total
        const entregues = limparInt(row[8]); // Entregues
        const transf159 = limparInt(row[11]);
        const transf160 = limparInt(row[12]);

        const evolucao = normalizarEvolucao(row[19]); // Evolu√ß√£o

        LOG(
          "CAF:",
          caf,
          "| Total:",
          qtdeTotal,
          "| Entregues:",
          entregues,
          "| Evolucao:",
          evolucao,
        );

        // üî¥ CAF zerada
        if (qtdeTotal === 0 && entregues === 0 && evolucao === 0) {
          mapa[caf] = { tipo: "zerada", qtde: 0 };
          continue;
        }

        // üü¢ CAF eleg√≠vel
        if (qtdeTotal > 0 && qtdeTotal === entregues && evolucao >= 99.9) {
          mapa[caf] = { tipo: "normal", qtde: qtdeTotal };
        }
      }

      LOG("TOTAL CLASSIFICADAS:", Object.keys(mapa).length);

      return mapa;
    }

    async function analisarResumoPlanilha() {
      if (!PLANILHA_CARREGADA) {
        alert("Selecione primeiro a planilha local.");
        return;
      }

      const linhasPlanilha = PLANILHA_CARREGADA;

      if (!linhasPlanilha || !linhasPlanilha.length) {
        alert("N√£o foi poss√≠vel carregar a planilha.");
        return;
      }

      const mapaCAF = classificarCAFPlanilha(linhasPlanilha);

      let totalElegiveis = 0;
      let totalZeradas = 0;

      let itensElegiveis = 0;
      let itensZeradas = 0;

      for (const caf in mapaCAF) {
        const info = mapaCAF[caf];

        if (info.tipo === "zerada") {
          totalZeradas++;
          itensZeradas += info.qtde || 0;
        } else {
          totalElegiveis++;
          itensElegiveis += info.qtde || 0;
        }
      }

      const msg = `üìä RESUMO DA PLANILHA

CAF Eleg√≠veis: ${totalElegiveis}
Total itens eleg√≠veis: ${itensElegiveis}

CAF Zeradas: ${totalZeradas}
Total itens zeradas: ${itensZeradas}

TOTAL GERAL DE CAF: ${totalElegiveis + totalZeradas}
TOTAL GERAL DE ITENS: ${itensElegiveis + itensZeradas}
`;

      // üî• janela copi√°vel igual voc√™ j√° usa
      const box = document.createElement("div");
      box.style = `
        position:fixed;
        left:50%;
        top:50%;
        transform:translate(-50%,-50%);
        z-index:999999;
        background:#fff;
        border:1px solid #ccc;
        border-radius:8px;
        padding:10px;
        box-shadow:0 4px 12px rgba(0,0,0,.3);
        width:420px;
    `;

      const textarea = document.createElement("textarea");
      textarea.value = msg;
      textarea.style = `
        width:100%;
        height:220px;
        font-family:monospace;
        font-size:13px;
    `;

      const btnFechar = document.createElement("button");
      btnFechar.innerText = "Fechar";
      btnFechar.style = `
        margin-top:8px;
        padding:6px 10px;
        background:#dc3545;
        color:#fff;
        border:none;
        border-radius:4px;
        cursor:pointer;
    `;

      btnFechar.onclick = () => box.remove();

      box.appendChild(textarea);
      box.appendChild(btnFechar);
      document.body.appendChild(box);

      textarea.select();
    }

    async function processarLinhas() {
      if (!PLANILHA_CARREGADA || !PLANILHA_CARREGADA.length) {
        alert("Selecione primeiro a planilha local.");
        return;
      }

      // ===============================
      // üî• PERIODO DA AUTOMA√á√ÉO
      // ===============================
      let periodo = sessionStorage.getItem("CAF_AUTO_PERIODO");

      if (!periodo) {
        const dataInicial = prompt("Informe a DATA INICIAL (dd/mm/aaaa):");
        if (!dataInicial) return;

        const dataFinal = prompt("Informe a DATA FINAL (dd/mm/aaaa):");
        if (!dataFinal) return;

        periodo = {
          dataInicial,
          dataFinal,
          limit: 100,
        };

        sessionStorage.setItem("CAF_AUTO_PERIODO", JSON.stringify(periodo));

        const primeiraURL =
          `${location.origin}/agentes/caf.php` +
          `?page=0` +
          `&limit=100` +
          `&caf_order=c.cafid` +
          `&cafstatus=0` +
          `&data_inicial=${encodeURIComponent(dataInicial)}` +
          `&data_final=${encodeURIComponent(dataFinal)}`;

        sessionStorage.setItem(AUTO_STATE_KEY, "1");

        LOG("üöÄ Primeira carga controlada:", primeiraURL);

        location.href = primeiraURL;
        return;
      }

      periodo = JSON.parse(periodo);

      processadas = Number(sessionStorage.getItem(AUTO_PROCESSADAS_KEY) || "0");

      logsProcessamento = [];
      try {
        const cacheLogs = sessionStorage.getItem(AUTO_LOGS_KEY);

        if (cacheLogs) {
          logsProcessamento = JSON.parse(cacheLogs);
          LOG("‚ôªÔ∏è Logs restaurados:", logsProcessamento.length);
        }
      } catch (e) {}

      stopRequested = false;
      isPaused = false;

      btnPause.disabled = false;
      btnStop.disabled = false;

      inicioProcessamento = Date.now();
      cafDurations = [];

      if (!MAPA_PLANILHA_CACHE) {
        MAPA_PLANILHA_CACHE = classificarCAFPlanilha(PLANILHA_CARREGADA);
      }

      const mapaCAF = MAPA_PLANILHA_CACHE;

      totalElegiveis = Object.keys(mapaCAF).filter(
        (c) => mapaCAF[c].tipo !== "zerada",
      ).length;

      atualizarContadorUI();

      LOG("üöÄ Processando p√°gina atual");

      garantirPaginacao100();
      await wait(1200);

      const linhas = obterLinhasValidas();

      for (const row of linhas) {
        if (stopRequested) break;

        const tds = row.querySelectorAll("td");
        if (!tds.length) continue;

        const numeroCAF = tds[0].innerText.trim();

        if (!mapaCAF[numeroCAF]) continue;
        if (mapaCAF[numeroCAF].tipo === "zerada") continue;

        // ‚úÖ ETAPA 16 ‚Äî se estiver em modo "target", processa s√≥ as CAFs da lista
        try {
          if (CAF.engine && CAF.engine.isTargeted && CAF.engine.isTargeted()) {
            const alvo = CAF.engine.getTargetList();
            if (alvo.indexOf(String(numeroCAF)) === -1) {
              continue;
            }
          }
        } catch (e) {}

        // üî• N√ÉO PROCESSA DUPLICADO
        if (jaProcessouCAF(numeroCAF)) {
          LOG("‚è≠Ô∏è CAF j√° processada anteriormente:", numeroCAF);
          continue;
        }

        const btnEncerrar =
          tds[21]?.querySelector("a") || tds[22]?.querySelector("a");

        if (!btnEncerrar) continue;

        currentCAF = numeroCAF;
        atualizarProgressoUI();

        LOG("üéØ Encerrando CAF:", numeroCAF);

        let cafStart = Date.now();

        try {
          btnEncerrar.click();
        } catch (e) {
          registrarLogObj(numeroCAF, "Linha", "Falha", e.message);
          continue;
        }

        await wait(1200);

        const resultado = await processarFluxoModaisParaCAF(numeroCAF);

        const dur = (Date.now() - cafStart) / 1000;
        cafDurations.push(dur);

        processadas++;
        sessionStorage.setItem(AUTO_PROCESSADAS_KEY, String(processadas));

        if (resultado && resultado.ok) {
          marcarCAFProcessada(numeroCAF);

          registrarLogObj(
            numeroCAF,
            "Resultado Final",
            "Processada com sucesso",
          );
        } else {
          registrarLogObj(
            numeroCAF,
            "Resultado Final",
            "Falha",
            resultado?.reason || "erro",
          );
        }

        atualizarContadorUI();

        await wait(900);
      }

      await processarModal4_tryClose("FINAL-PAGINA");
      await wait(1200);

      // ==================================
      // üî• CONTROLE INTELIGENTE DE FINALIZA√á√ÉO
      // ==================================

      const cafsProcessadasLista = getCafsProcessadas();

      const totalPlanilhaElegiveis = Object.keys(mapaCAF).filter(
        (c) => mapaCAF[c].tipo !== "zerada",
      ).length;

      const todasProcessadas =
        cafsProcessadasLista.length >= totalPlanilhaElegiveis;

      const urlAtual = new URL(location.href);
      const pageAtual = Number(urlAtual.searchParams.get("page") || "0");

      const totalLinhasPlanilha = Math.max(0, PLANILHA_CARREGADA.length - 1);
      const totalPaginas = Math.ceil(totalLinhasPlanilha / 100);
      const paginaIndexAtual = pageAtual / 100;

      LOG(
        "üìä Controle Final:",
        "Processadas:",
        cafsProcessadasLista.length,
        "TotalElegiveis:",
        totalPlanilhaElegiveis,
        "PaginaIndex:",
        paginaIndexAtual,
        "TotalPaginas:",
        totalPaginas,
      );

      // üî¥ FINALIZA SE TODAS CAF PROCESSADAS
      if (todasProcessadas) {
        LOG("üèÅ Todas CAF eleg√≠veis da planilha foram processadas.");

        sessionStorage.removeItem(AUTO_STATE_KEY);
        sessionStorage.removeItem(AUTO_PROCESSADAS_KEY);
        sessionStorage.removeItem(AUTO_PERIODO_KEY);
        sessionStorage.removeItem(AUTO_CAFS_DONE_KEY);

        atualizarProgressoUI();

        btnStart.disabled = false;
        btnStart.style.background = "#28a745";
        btnStart.innerText = "Encerrar CAF's Normais";

        btnPause.disabled = true;
        btnStop.disabled = true;

        LOG("üìÑ Gerando logs finais...");

        try {
          await baixarLogXlsx();
          await baixarLogTxt();
        } catch (e) {
          console.warn("Falha ao gerar logs finais:", e);
        }

        // üß™ DEV: snapshot antes de limpar logs
        try {
          if (CAF.logs && CAF.logs.enabled) {
            CAF.logs.saveSnapshotBeforeUnload();
          }
        } catch (e) {}

        sessionStorage.removeItem(AUTO_LOGS_KEY);
        sessionStorage.removeItem(AUTO_START_TIME_KEY);

        // ‚úÖ ETAPA 13 ‚Äî verifica√ß√£o final de pendentes (somente LOG)
        try {
          const listaElegiveis = Object.keys(mapaCAF).filter(
            (c) => mapaCAF[c].tipo !== "zerada",
          );
          const pend = CAF.engine.verificarPendentesAoFinal(listaElegiveis);

          // ‚úÖ ETAPA 14 (fase 1) ‚Äî salva pendentes para uso futuro
          CAF.engine.salvarPendentes(pend);

          // marca que ainda N√ÉO reprocessou nesta execu√ß√£o
          CAF.engine.setReprocessDone(false);

          await CAF.engine.tryAutoReprocess();

          if (CAF.logs && CAF.logs.enabled) {
            console.log("üíæ Pendentes salvas (sem reprocessar):", pend.length);
          }
        } catch (e) {}

        // ‚úÖ ETAPA 16 ‚Äî reprocessa automaticamente (uma vez) se houver pendentes
        try {
          await CAF.engine.tryAutoReprocessFinal();
        } catch (e) {}

        return;
      }

      // üîµ FINALIZA SE CHEGOU NA √öLTIMA P√ÅGINA
      if (paginaIndexAtual >= totalPaginas - 1) {
        LOG("üèÅ √öltima p√°gina baseada na planilha atingida.");

        sessionStorage.removeItem(AUTO_STATE_KEY);
        sessionStorage.removeItem(AUTO_PROCESSADAS_KEY);
        sessionStorage.removeItem(AUTO_PERIODO_KEY);
        sessionStorage.removeItem(AUTO_CAFS_DONE_KEY);

        atualizarProgressoUI();

        btnStart.disabled = false;
        btnStart.style.background = "#28a745";
        btnStart.innerText = "Encerrar CAF's Normais";

        btnPause.disabled = true;
        btnStop.disabled = true;
        LOG("üìÑ Gerando logs finais...");

        try {
          await baixarLogXlsx();
          await baixarLogTxt();
        } catch (e) {
          console.warn("Falha ao gerar logs finais:", e);
        }

        // üß™ DEV: snapshot antes de limpar logs
        try {
          if (CAF.logs && CAF.logs.enabled) {
            CAF.logs.saveSnapshotBeforeUnload();
          }
        } catch (e) {}

        sessionStorage.removeItem(AUTO_LOGS_KEY);
        sessionStorage.removeItem(AUTO_START_TIME_KEY);

        // ‚úÖ ETAPA 13 ‚Äî verifica√ß√£o final de pendentes (somente LOG)
        try {
          const listaElegiveis = Object.keys(mapaCAF).filter(
            (c) => mapaCAF[c].tipo !== "zerada",
          );
          const pend = CAF.engine.verificarPendentesAoFinal(listaElegiveis);

          // ‚úÖ ETAPA 14 (fase 1) ‚Äî salva pendentes para uso futuro
          CAF.engine.salvarPendentes(pend);

          // marca que ainda N√ÉO reprocessou nesta execu√ß√£o
          CAF.engine.setReprocessDone(false);

          if (CAF.logs && CAF.logs.enabled) {
            console.log("üíæ Pendentes salvas (sem reprocessar):", pend.length);
          }
        } catch (e) {}

        // ‚úÖ ETAPA 16 ‚Äî reprocessa automaticamente (uma vez) se houver pendentes
        try {
          await CAF.engine.tryAutoReprocessFinal();
        } catch (e) {}

        return;
      }

      // ==================================
      // üî• PR√ìXIMA P√ÅGINA SEGURA
      // ==================================

      const proximaPagina = pageAtual + LIMIT_PAGINA;

      const novaURL =
        `${location.origin}/agentes/caf.php` +
        `?page=${proximaPagina}` +
        `&limit=100` +
        `&caf_order=c.cafid` +
        `&cafstatus=0` +
        `&data_inicial=${encodeURIComponent(periodo.dataInicial)}` +
        `&data_final=${encodeURIComponent(periodo.dataFinal)}`;

      if (stopRequested) {
        LOG("üõë Stop solicitado ‚Äî n√£o ir√° para pr√≥xima p√°gina");

        sessionStorage.removeItem(AUTO_STATE_KEY);

        btnStart.disabled = false;
        btnStart.style.background = "#28a745";
        btnStart.innerText = "Encerrar CAF's Normais";

        return;
      }

      LOG("‚û°Ô∏è Indo para pr√≥xima p√°gina:", novaURL);

      sessionStorage.setItem(AUTO_STATE_KEY, "1");

      location.href = novaURL;
    }

    async function processarLinhasZeradas() {
      const linhas = obterLinhasValidas();

      for (const row of linhas) {
        const tds = row.querySelectorAll("td");

        // if (!ehCAFZerada_row(tds)) continue;

        const numeroCAF = tds[0].innerText.trim();

        const btn = tds[21]?.querySelector("a") || tds[22]?.querySelector("a");

        btn.click();

        await wait(1200);

        await processarFluxoCAFZerada(numeroCAF);

        await wait(1500);
      }
    }

    // ======================================
    // üß† ENGINE EXPORT (ETAPA 7 - FASE 1)
    // ======================================

    CAF.engine = CAF.engine || {};

    // "main" (execu√ß√£o)
    CAF.engine.processarLinhas = processarLinhas;
    CAF.engine.processarLinhasZeradas = processarLinhasZeradas;

    // fluxos/modais
    CAF.engine.processarModal1 = processarModal1;
    CAF.engine.processarModal2 = processarModal2;
    CAF.engine.processarModal3 = processarModal3;
    CAF.engine.processarModal4_tryClose = processarModal4_tryClose;

    CAF.engine.processarFluxoModaisParaCAF = processarFluxoModaisParaCAF;
    CAF.engine.processarFluxoCAFZerada = processarFluxoCAFZerada;

    // ======================================
    // üöÄ ENGINE STARTERS (ETAPA 8)
    // ======================================

    CAF.engine.startNormais = async function () {
      CAF.engine.initRunContext({ newRun: true, attempt: 1 });
      CAF.engine.clearTargetList();
      // ====== (copiado do btnStart click: reset + UI) ======
      btnStart.disabled = true;
      btnStart.style.background = "#777";
      // ‚úÖ N√ÉO INICIA sem planilha (evita ficar "Processando..." incorretamente)
      if (!PLANILHA_CARREGADA || !PLANILHA_CARREGADA.length) {
        alert(
          "‚ö†Ô∏è Nenhuma planilha carregada. Clique em 'Carregar Planilha' primeiro.",
        );
        // garante que mant√©m o texto correto do bot√£o
        try {
          btnStart.disabled = false;
          btnStart.style.background = "#28a745";
          btnStart.innerText = "Encerrar CAF's Normais";
        } catch (e) {}
        return;
      }
      btnStart.innerText = "Processando...";

      totalElegiveis = 0;
      processadas = 0;
      logsProcessamento = [];
      stopRequested = false;
      isPaused = false;

      btnPause.disabled = false;
      btnPause.style.opacity = 1;
      btnPause.innerText = "Pausar";

      btnStop.disabled = false;
      btnStop.style.opacity = 1;

      // ====== (start time global) ======
      let startSaved = sessionStorage.getItem(AUTO_START_TIME_KEY);

      if (!startSaved) {
        startSaved = Date.now();
        sessionStorage.setItem(AUTO_START_TIME_KEY, String(startSaved));
        LOG("‚è±Ô∏è In√≠cio global salvo:", startSaved);
      }

      inicioProcessamento = Number(startSaved);

      atualizarProgressoUI();

      // ====== (controle pagina√ß√£o / estado) ======
      sessionStorage.setItem(AUTO_PAGINA_KEY, "0");
      sessionStorage.removeItem(AUTO_PROCESSADAS_KEY);

      // üî• MUITO IMPORTANTE (mantido do seu fluxo)
      sessionStorage.removeItem(AUTO_STATE_KEY);
      sessionStorage.removeItem("CAF_AUTO_PERIODO");

      // ====== (chama engine) ======
      await CAF.engine.processarLinhas();
    };

    // ======================================
    // üÜî RUN CONTEXT (ETAPA 14 - FASE 1)
    // ======================================

    const CAF_RUN_ID_KEY = "CAF_RUN_ID";
    const CAF_RUN_ATTEMPT_KEY = "CAF_RUN_ATTEMPT";
    const CAF_EVENT_SEQ_KEY = "CAF_EVENT_SEQ";

    CAF.engine.getRunId = function () {
      return sessionStorage.getItem(CAF_RUN_ID_KEY) || "";
    };

    CAF.engine.getAttempt = function () {
      return Number(sessionStorage.getItem(CAF_RUN_ATTEMPT_KEY) || "1");
    };

    CAF.engine.initRunContext = function (opts) {
      try {
        const isNew = !!(opts && opts.newRun);

        if (isNew || !sessionStorage.getItem(CAF_RUN_ID_KEY)) {
          const rid = `run_${Date.now()}_${Math.random().toString(16).slice(2)}`;
          sessionStorage.setItem(CAF_RUN_ID_KEY, rid);
          sessionStorage.setItem(
            CAF_RUN_ATTEMPT_KEY,
            String(opts?.attempt || 1),
          );
          sessionStorage.setItem(CAF_EVENT_SEQ_KEY, "0");
        }
      } catch (e) {}
    };

    CAF.engine.nextEventId = function () {
      try {
        const n = Number(sessionStorage.getItem(CAF_EVENT_SEQ_KEY) || "0") + 1;
        sessionStorage.setItem(CAF_EVENT_SEQ_KEY, String(n));
        return n;
      } catch (e) {
        return 0;
      }
    };

    // ======================================
    // üîÅ RESUME ENGINE (ETAPA 10 - CORRIGIDA)
    // ======================================

    CAF.engine.resumeIfNeeded = async function () {
      try {
        if (sessionStorage.getItem(AUTO_STATE_KEY) !== "1") {
          return false;
        }

        LOG("üöÄ Retomando processamento automaticamente (p√≥s pagina√ß√£o)");

        // üî• UI (mant√©m exatamente como era antes)
        btnStart.disabled = true;
        btnStart.style.background = "#777";
        btnStart.innerText = "Processando...";

        // chama engine direto (igual fazia antes)
        await CAF.engine.processarLinhas();

        return true;
      } catch (e) {
        console.error("Erro resumeIfNeeded:", e);
        return false;
      }
    };

    // ======================================
    // üìã DETECTAR PENDENTES (ETAPA 12)
    // ======================================

    CAF.engine.detectarPendentes = function (listaOriginal) {
      try {
        const closedMap = CAF.storage.getClosedMap() || {};
        const pendentes = [];

        (listaOriginal || []).forEach((caf) => {
          const key = String(caf || "").trim();

          if (!closedMap[key]) {
            pendentes.push(key);
          }
        });

        if (CAF.logs && CAF.logs.enabled) {
          console.log("üìã Pendentes detectadas:", pendentes);
        }

        return pendentes;
      } catch (e) {
        console.error("Erro detectarPendentes:", e);
        return [];
      }
    };

    // ======================================
    // üß† VERIFICAR PENDENTES AO FINAL (ETAPA 13)
    // ======================================

    CAF.engine.verificarPendentesAoFinal = function (listaElegiveis) {
      try {
        const elegiveis = (listaElegiveis || [])
          .map((x) => String(x || "").trim())
          .filter(Boolean);
        const closedMap =
          (CAF.storage.getClosedMap && CAF.storage.getClosedMap()) || {};
        const pendentes = CAF.engine.detectarPendentes(elegiveis);

        const report = {
          createdAtLocal: new Date().toLocaleString("pt-BR"),
          createdAtISO: new Date().toISOString(),
          runId: (CAF.engine.getRunId && CAF.engine.getRunId()) || "",
          attempt: (CAF.engine.getAttempt && CAF.engine.getAttempt()) || 1,
          elegiveisTotal: elegiveis.length,
          encerradasTotal: Object.keys(closedMap).length,
          pendentesTotal: pendentes.length,
          elegiveis,
          pendentes,
        };

        CAF.engine.salvarRelatorioFinal(report);

        if (CAF.logs && CAF.logs.enabled) {
          console.log(
            "üìä Verifica√ß√£o final ‚Äî eleg√≠veis:",
            report.elegiveisTotal,
          );
          console.log(
            "üìä Verifica√ß√£o final ‚Äî pendentes:",
            report.pendentesTotal,
          );

          if (pendentes.length) {
            console.warn("‚ö†Ô∏è CAFs pendentes detectadas:", pendentes);
          } else {
            console.log("‚úÖ Nenhuma CAF pendente.");
          }
        }

        return pendentes;
      } catch (e) {
        console.error("Erro verificarPendentesAoFinal:", e);
        return [];
      }
    };

    // ======================================
    // üßæ RELAT√ìRIO FINAL (ETAPA 15)
    // ======================================

    const CAF_FINAL_REPORT_KEY = "CAF_FINAL_REPORT_V1";

    CAF.engine.salvarRelatorioFinal = function (report) {
      try {
        localStorage.setItem(
          CAF_FINAL_REPORT_KEY,
          JSON.stringify(report || {}),
        );
        return true;
      } catch (e) {
        return false;
      }
    };

    CAF.engine.getRelatorioFinal = function () {
      try {
        return (
          JSON.parse(localStorage.getItem(CAF_FINAL_REPORT_KEY) || "{}") || {}
        );
      } catch (e) {
        return {};
      }
    };

    // ======================================
    // üéØ TARGET LIST (PENDENTES) ‚Äî ETAPA 16
    // ======================================

    const CAF_TARGET_LIST_KEY = "CAF_TARGET_LIST_V1";

    CAF.engine.setTargetList = function (list) {
      try {
        const arr = (list || [])
          .map((x) => String(x || "").trim())
          .filter(Boolean);
        sessionStorage.setItem(CAF_TARGET_LIST_KEY, JSON.stringify(arr));
        return true;
      } catch (e) {
        return false;
      }
    };

    CAF.engine.getTargetList = function () {
      try {
        return (
          JSON.parse(sessionStorage.getItem(CAF_TARGET_LIST_KEY) || "[]") || []
        );
      } catch (e) {
        return [];
      }
    };

    CAF.engine.clearTargetList = function () {
      try {
        sessionStorage.removeItem(CAF_TARGET_LIST_KEY);
      } catch (e) {}
    };

    CAF.engine.isTargeted = function () {
      try {
        const arr = CAF.engine.getTargetList();
        return Array.isArray(arr) && arr.length > 0;
      } catch (e) {
        return false;
      }
    };

    // ======================================
    // ‚ôªÔ∏è REPROCESSAMENTO (PREP) ‚Äî ETAPA 14 FASE 1
    // ======================================

    const CAF_PENDENTES_KEY = "CAF_PENDENTES_V1";
    const CAF_REPROCESS_DONE_KEY = "CAF_REPROCESS_DONE_V1";

    CAF.engine.salvarPendentes = function (pendentes) {
      try {
        localStorage.setItem(
          CAF_PENDENTES_KEY,
          JSON.stringify(pendentes || []),
        );
        return true;
      } catch (e) {
        return false;
      }
    };

    CAF.engine.getPendentesSalvas = function () {
      try {
        return (
          JSON.parse(localStorage.getItem(CAF_PENDENTES_KEY) || "[]") || []
        );
      } catch (e) {
        return [];
      }
    };

    CAF.engine.setReprocessDone = function (done) {
      try {
        localStorage.setItem(CAF_REPROCESS_DONE_KEY, done ? "1" : "0");
      } catch (e) {}
    };

    CAF.engine.isReprocessDone = function () {
      try {
        return localStorage.getItem(CAF_REPROCESS_DONE_KEY) === "1";
      } catch (e) {
        return false;
      }
    };

    // ======================================
    // ‚ôªÔ∏è AUTO REPROCESS FINAL ‚Äî ETAPA 16
    // ======================================

    CAF.engine.tryAutoReprocessFinal = async function () {
      try {
        // n√£o reprocessa se usu√°rio pediu stop
        if (typeof stopRequested !== "undefined" && stopRequested) {
          return false;
        }

        const report = CAF.engine.getRelatorioFinal
          ? CAF.engine.getRelatorioFinal()
          : {};
        const pendentes =
          report && Array.isArray(report.pendentes) ? report.pendentes : [];

        if (!pendentes.length) {
          return false;
        }

        if (CAF.engine.isReprocessDone && CAF.engine.isReprocessDone()) {
          return false;
        }

        // marca para n√£o entrar em loop
        CAF.engine.setReprocessDone(true);

        // attempt 2
        const nextAttempt =
          (CAF.engine.getAttempt ? CAF.engine.getAttempt() : 1) + 1;
        try {
          sessionStorage.setItem(CAF_RUN_ATTEMPT_KEY, String(nextAttempt));
        } catch (e) {}

        // define lista-alvo e reinicia processamento na mesma p√°gina (sem mudar regra)
        CAF.engine.setTargetList(pendentes);

        if (CAF.logs && CAF.logs.enabled) {
          console.warn(
            "‚ôªÔ∏è Reprocessamento autom√°tico iniciado (target list):",
            pendentes.length,
            "attempt:",
            nextAttempt,
          );
        }

        // importante: n√£o recria per√≠odo / n√£o muda p√°gina
        await CAF.engine.processarLinhas();

        return true;
      } catch (e) {
        console.error("Erro tryAutoReprocessFinal:", e);
        return false;
      }
    };

    // ======================================
    // ‚ôªÔ∏è AUTO REPROCESS (ETAPA 14 - FASE 2)
    // ======================================

    CAF.engine.tryAutoReprocess = async function () {
      try {
        const pendentes = CAF.engine.getPendentesSalvas();

        if (!pendentes || !pendentes.length) {
          return false;
        }

        if (CAF.engine.isReprocessDone()) {
          if (CAF.logs && CAF.logs.enabled) {
            console.log("üîÅ Reprocessamento j√° realizado anteriormente.");
          }
          return false;
        }

        if (CAF.logs && CAF.logs.enabled) {
          console.warn(
            "‚ôªÔ∏è Iniciando reprocessamento autom√°tico:",
            pendentes.length,
          );
        }

        // marca como j√° reprocessado
        CAF.engine.setReprocessDone(true);

        // aumenta attempt
        const newAttempt = CAF.engine.getAttempt() + 1;
        sessionStorage.setItem(CAF_RUN_ATTEMPT_KEY, String(newAttempt));

        // reusa start oficial
        await CAF.engine.processarLinhas();

        return true;
      } catch (e) {
        console.error("Erro tryAutoReprocess:", e);
        return false;
      }
    };

    CAF.engine.startZeradas = async function () {
      btnStartZeradas.disabled = true;
      btnStartZeradas.style.background = "#777";
      btnStartZeradas.innerText = "Processando Zeradas...";

      await CAF.engine.startZeradas();
    };

    /* ========= eventos ========= */
    btnStart.addEventListener("click", async () => {
      if (!(await CAF.security.guard("start_normais"))) return;

      try {
        await CAF.engine.startNormais();
      } catch (e) {
        console.error("Erro startNormais:", e);
      }
    });

    setInterval(() => {
      if (!btnStart.disabled) atualizarContadorUI();
    }, 6000);

    btnStartZeradas.addEventListener("click", async () => {
      if (!(await CAF.security.guard("start_zeradas"))) return;

      btnStartZeradas.disabled = true;
      await CAF.engine.processarLinhasZeradas();
      btnStartZeradas.disabled = false;
    });

    btnAnalisePlanilha.addEventListener(
      "click",
      async (e) => {
        if (!(await CAF.security.guard("resumo_processamento"))) return;

        e.preventDefault();
        e.stopImmediatePropagation();

        console.log("üî• CLICK REAL CAPTURADO");

        try {
          console.log("üî• chamando analisarResumoPlanilha...");

          await analisarResumoPlanilha();

          console.log("üî• analisarResumoPlanilha FINALIZOU");
        } catch (err) {
          console.error("‚ùå ERRO AO EXECUTAR:", err);
        }
      },
      true,
    );

    btnSelecionarPlanilha.onclick = async () => {
      if (!(await CAF.security.guard("carregar_planilha"))) return;
      inputPlanilhaLocal.click();
    };

    inputPlanilhaLocal.addEventListener("change", async function () {
      if (!(await CAF.security.guard("carregar_planilha"))) return;

      const file = inputPlanilhaLocal.files[0];

      if (!file) {
        alert("Nenhuma planilha selecionada.");
        return;
      }

      LOG("üìÇ Arquivo selecionado:", file.name);

      const linhas = await carregarPlanilhaLocal(file);

      if (!linhas || !linhas.length) {
        alert("Falha ao ler planilha.");
        return;
      }

      MAPA_PLANILHA_CACHE = classificarCAFPlanilha(linhas);
      const mapaCAF = MAPA_PLANILHA_CACHE;

      totalElegiveis = Object.keys(mapaCAF).filter(
        (c) => mapaCAF[c].tipo !== "zerada",
      ).length;

      atualizarContadorUI();

      alert("‚úÖ Planilha carregada com sucesso!");
    });

    btnClearStorage.onclick = async () => {
      if (!(await CAF.security.guard("limpar_storage"))) return;

      if (!confirm("Deseja limpar TODOS os dados da automa√ß√£o?")) return;

      sessionStorage.removeItem(AUTO_STATE_KEY);
      sessionStorage.removeItem(AUTO_PROCESSADAS_KEY);
      sessionStorage.removeItem(AUTO_PERIODO_KEY);
      sessionStorage.removeItem("CAF_PLANILHA");

      LOG("üßπ Storage limpo manualmente");

      alert("Storage limpo. Recarregue a p√°gina.");
    };
    /* ========= interceptador de clique para carregaEncomendasSelecionadas(...) =========
       Captura quando o usu√°rio clica no link que chama essa fun√ß√£o e extrai numcaf + unidade (quando poss√≠vel)
       mant√©m dados preliminares para estimativa antes da abertura do modal.
    */
    document.addEventListener(
      "click",
      (ev) => {
        try {
          let el = ev.target;
          // sobe at√© encontrar um <a> ou elemento com onclick
          while (el && el !== document.body) {
            if (el.getAttribute && el.getAttribute("onclick")) break;
            el = el.parentElement;
          }
          if (!el || !el.getAttribute) return;
          const onclick = el.getAttribute("onclick") || "";
          if (!onclick.includes("carregaEncomendasSelecionadas")) return;

          const m = onclick.match(
            /carregaEncomendasSelecionadas\s*\(\s*([0-9]+)\s*,\s*([0-9]+)\s*,\s*['"]?([^'"\),]+)['"]?\s*,\s*['"]?([^'"\)]+)['"]?\s*\)/i,
          );
          if (m) {
            const cafNum = m[1];
            const unidade = m[2];
            // armazena captura preliminar (qtde desconhecida por esse onclick, mas marca presen√ßa)
            if (!capturasPreliminares[cafNum])
              capturasPreliminares[cafNum] = { expectedItems: 0, unidade };
            // mostra um aviso r√°pidobadgeCAFAtual.innerText = `CAF:${cafNum}`;
            badgeCAFAtual.innerText = `CAF:${cafNum}`;

            // limpa depois de 6s
            setTimeout(() => atualizarContadorUI(), 6000);
          }
        } catch (e) {
          /* silent */
        }
      },
      true,
    );

    /* ========= helpers finais ========= */
    // fun√ß√£o para calcular estima completa (usada UI)
    function estimativaTotal() {
      const soma = cafDurations.reduce((a, b) => a + b, 0);
      const media = cafDurations.length ? soma / cafDurations.length : null;
      const total = totalElegiveis;
      const restante = Math.max(0, total - processadas);
      return { media, estimRest: media ? media * restante : null };
    }

    /* ========= export itens j√° ligado acima a btnExportItems (mantido) ========= */

    // manter bot√£o XLSX original e export logs via baixarLogXlsx/baixarLogTxt (chamados no final)

    // final
    atualizarContadorUI();

    // ======================================
    // üîê HASH GLOBAL DO SCRIPT (BOOT REAL)
    // ======================================
    (async () => {
      try {
        const hash = await gerarHashScript();

        window.__CAF_SCRIPT_HASH = hash;

        LOG("üîê Hash do script carregado:", hash);
      } catch (e) {
        console.warn("Falha ao gerar hash inicial:", e);
      }
    })();

    // ================================
    // üî• AUTO CONTINUA√á√ÉO AP√ìS PAGINA√á√ÉO
    // ================================
    setTimeout(async () => {
      await CAF.engine.resumeIfNeeded();
    }, 1500);
  }

  // üî• BOOT SEGURO ‚Äî ESPERA BODY EXISTIR
  (function aguardarDOM() {
    if (!document.body) {
      requestAnimationFrame(aguardarDOM);
      return;
    }

    bootCAF();
  })();
})();
